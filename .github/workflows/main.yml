name: Build FFmpeg with MSVC

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release after build'
        required: false
        default: 'false'
        type: boolean

# 新增：提升GITHUB_TOKEN权限（解决Release创建权限问题）
permissions:
  contents: write
  actions: read

env:
  FFPEG_VERSION: 5.1.4
  # 统一路径（避免混合分隔符）
  WORKSPACE: ${{ github.workspace }}
  X264_INSTALL: ${{ github.workspace }}\x264-install
  FFMPEG_INSTALL: ${{ github.workspace }}\ffmpeg-install

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup MSYS2 (仅用于依赖下载/辅助工具，不参与编译)
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          git
          make
          wget
          unzip
          sed
          pkg-config
          mingw-w64-x86_64-winflexbison
          mingw-w64-x86_64-yasm
      
    - name: Setup Visual Studio Environment (MSVC核心环境)
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        toolset: latest
        
    - name: Install MSVC编译依赖
      run: |
        # 安装nasm（MSVC编译FFmpeg必需）、cmake
        choco install nasm -y --no-progress
        choco install cmake -y --no-progress --install-arguments 'ADD_CMAKE_TO_PATH=System'
        # 刷新环境变量
        refreshenv
        
    - name: Clone x264 Source (适配MSVC编译)
      shell: cmd
      run: |
        cd %WORKSPACE%
        rmdir /s /q x264 2>nul || true
        git clone --depth=1 https://code.videolan.org/videolan/x264.git x264
        cd x264 && git rev-parse --short HEAD && cd ..
        
    - name: Build x264 with MSVC (关键修复：生成MSVC格式库)
      shell: cmd
      run: |
        cd %WORKSPACE%\x264
        :: 清理旧产物
        make clean 2>nul || true
        rmdir /s /q build 2>nul || true
        mkdir build && cd build
        
        :: 使用cmake生成MSVC工程（核心：适配MSVC）
        cmake .. -G "Visual Studio 17 2022" -A x64 ^
          -DCMAKE_INSTALL_PREFIX=%X264_INSTALL% ^
          -DENABLE_SHARED=ON ^
          -DENABLE_STATIC=OFF ^
          -DENABLE_ASM=OFF ^
          -DCMAKE_BUILD_TYPE=Release
        
        :: 编译并安装（MSVC格式的.lib/.dll）
        cmake --build . --config Release --target install -j %NUMBER_OF_PROCESSORS%
        
    - name: Clone FFmpeg Source 
      shell: cmd
      run: |
        cd %WORKSPACE%
        rmdir /s /q ffmpeg 2>nul || true
        git clone --depth=1 --branch=n%FFPEG_VERSION% https://github.com/FFmpeg/FFmpeg.git ffmpeg
        cd ffmpeg && git rev-parse --short HEAD && cd ..
        
    - name: Patch FFmpeg libm.h (修复数学函数定义)
      shell: msys2 {0}
      run: |
        cd $WORKSPACE/ffmpeg/libavutil
        # 备份原文件
        cp libm.h libm.h.bak
        # 彻底禁用内部数学函数（覆盖所有HAVE_xxx判断）
        sed -i 's/#if !HAVE_/#if 0 \/\/ disabled for MSVC - #if !HAVE_/g' libm.h
        sed -i 's/#elif !HAVE_/#elif 0 \/\/ disabled for MSVC - #elif !HAVE_/g' libm.h
        # 验证修改
        cat libm.h | grep -E "#if 0.*HAVE_" | head -5
        
    - name: Build FFmpeg with MSVC (核心修复：纯MSVC编译)
      shell: cmd
      run: |
        cd %WORKSPACE%\ffmpeg
        :: 清理旧产物
        make clean 2>nul || true
        
        :: 设置环境变量（纯MSVC）
        set CC=cl
        set CXX=cl
        set LD=link
        set AR=lib
        set RANLIB=echo
        set STRIP=echo
        :: x264路径（MSVC格式）
        set INCLUDE=%X264_INSTALL%\include;%INCLUDE%
        set LIB=%X264_INSTALL%\lib;%LIB%
        :: pkg-config路径（识别x264.pc）
        set PKG_CONFIG_PATH=%X264_INSTALL%\lib\pkgconfig
        
        :: FFmpeg configure（纯MSVC参数，移除MinGW冲突项）
        ./configure ^
          --prefix=%FFMPEG_INSTALL% ^
          --target-os=win32 ^
          --arch=x86_64 ^
          --toolchain=msvc ^
          --enable-gpl ^
          --enable-version3 ^
          --enable-shared ^
          --disable-static ^
          --enable-libx264 ^
          --enable-w32threads ^
          --enable-postproc ^
          --enable-nonfree ^
          --disable-programs ^
          --disable-doc ^
          --disable-asm ^
          --extra-cflags="-MD -DHAVE_LRINT=1 -DHAVE_LRINTF=1 -DHAVE_RINT=1 -DHAVE_ROUND=1 -DHAVE_TRUNC=1 -DHAVE_CBRT=1 -DHAVE_ERF=1" ^
          --extra-ldflags="-LIBPATH:%X264_INSTALL%\lib"
        
        :: 编译（MSVC多线程）
        make -j %NUMBER_OF_PROCESSORS%
        :: 安装
        make install
        
    - name: Package Build Artifacts
      shell: cmd
      run: |
        :: 创建输出目录
        mkdir %WORKSPACE%\ffmpeg-build-output\bin 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\lib 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\include 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\licenses 2>nul || true
        
        :: 复制FFmpeg产物
        copy /Y %FFMPEG_INSTALL%\bin\*.dll %WORKSPACE%\ffmpeg-build-output\bin\
        copy /Y %FFMPEG_INSTALL%\lib\*.lib %WORKSPACE%\ffmpeg-build-output\lib\
        xcopy /E /Y %FFMPEG_INSTALL%\include\* %WORKSPACE%\ffmpeg-build-output\include\
        
        :: 复制x264产物（依赖）
        copy /Y %X264_INSTALL%\bin\*.dll %WORKSPACE%\ffmpeg-build-output\bin\
        copy /Y %X264_INSTALL%\lib\*.lib %WORKSPACE%\ffmpeg-build-output\lib\
        xcopy /E /Y %X264_INSTALL%\include\* %WORKSPACE%\ffmpeg-build-output\include\
        
        :: 复制许可证
        copy /Y %WORKSPACE%\ffmpeg\LICENSE.md %WORKSPACE%\ffmpeg-build-output\licenses\FFmpeg.txt 2>nul || true
        copy /Y %WORKSPACE%\x264\COPYING %WORKSPACE%\ffmpeg-build-output\licenses\x264.txt 2>nul || true
        
        :: 验证产物
        dir %WORKSPACE%\ffmpeg-build-output\bin
        dir %WORKSPACE%\ffmpeg-build-output\lib
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}
        path: ${{ env.WORKSPACE }}\ffmpeg-build-output\
        retention-days: 90
        
    - name: Package as ZIP
      shell: powershell
      run: |
        Compress-Archive -Path ${{ env.WORKSPACE }}\ffmpeg-build-output\* -DestinationPath ${{ env.WORKSPACE }}\ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}.zip -Force
        
    - name: Create Release (使用新版action，修复权限/废弃问题)
      id: create_release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: n${{ env.FFPEG_VERSION }}-${{ github.run_number }}
        name: FFmpeg Windows Build v${{ env.FFPEG_VERSION }}-${{ github.run_number }}
        draft: false
        prerelease: false
        files: ${{ env.WORKSPACE }}\ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}.zip
        body: |
          FFmpeg ${{ env.FFPEG_VERSION }} Windows build with:
          - MSVC 2022 toolchain (x64)
          - x264 support (MSVC build)
          - Shared libraries (DLL + LIB)
          - Headers for development
          
          ## Files included:
          - Binaries (DLLs)
          - MSVC import libraries (LIB)
          - Header files
          - Licenses
          
          ## Version Info
          - Build Number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
