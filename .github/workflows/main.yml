name: FFmpeg Windows Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Set up MSYS2 & Install Dependencies
      uses: msys2/setup-msys2@v2
      with:
        msystem: mingw64
        update: true
        install: >-
          base-devel
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-nasm
          mingw-w64-x86_64-yasm
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-libx264
          git
          pkg-config

    # 缓存FFmpeg源码，避免每次重复克隆（核心优化）
    - name: Cache FFmpeg Source (n5.1.4)
      id: cache-ffmpeg
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/ffmpeg
        key: ffmpeg-source-n5.1.4-${{ runner.os }}-${{ hashFiles('**/build.yml') }}
        restore-keys: |
          ffmpeg-source-n5.1.4-${{ runner.os }}-

    # 仅缓存未命中时克隆源码（第一次运行/版本变更时执行）
    - name: Clone FFmpeg Source (n5.1.4)
      if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
      shell: msys2 {0}
      run: |
        cd $GITHUB_WORKSPACE
        git clone --depth=1 --branch=n5.1.4 https://github.com/FFmpeg/FFmpeg.git ffmpeg
        # 验证版本是否正确
        cd ffmpeg && git rev-parse --short HEAD && cd ..

    - name: Build FFmpeg
      shell: msys2 {0}
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg
        
        # 清理旧编译产物（避免缓存干扰）
        make clean || true
        
        # 配置构建选项
        ./configure \
          --prefix="${{ github.workspace }}/ffmpeg-install" \
          --target-os=mingw32 \
          --arch=x86_64 \
          --enable-gpl \
          --enable-version3 \
          --enable-shared \
          --enable-static \
          --enable-libx264 \
          --enable-w32threads \
          --enable-postproc \
          --enable-nonfree \
          --disable-programs \
          --disable-doc \
          --extra-cflags="-I/mingw64/include" \
          --extra-ldflags="-L/mingw64/lib"
        
        # 编译（自动适配CPU核心数）
        make -j$(nproc)
        
        # 安装到指定目录
        make install

    - name: Package Build Artifacts
      shell: msys2 {0}
      run: |
        # 创建标准化输出目录
        mkdir -p "${{ github.workspace }}/ffmpeg-build-output/bin"
        mkdir -p "${{ github.workspace }}/ffmpeg-build-output/lib"
        mkdir -p "${{ github.workspace }}/ffmpeg-build-output/include"
        
        # 复制编译产物
        cp -f "${{ github.workspace }}/ffmpeg-install/bin/"*.dll "${{ github.workspace }}/ffmpeg-build-output/bin/" 2>/dev/null || true
        cp -f "${{ github.workspace }}/ffmpeg-install/lib/"*.lib "${{ github.workspace }}/ffmpeg-build-output/lib/" 2>/dev/null || true
        cp -f "${{ github.workspace }}/ffmpeg-install/lib/"*.dll.a "${{ github.workspace }}/ffmpeg-build-output/lib/" 2>/dev/null || true
        cp -r "${{ github.workspace }}/ffmpeg-install/include/"* "${{ github.workspace }}/ffmpeg-build-output/include/" 2>/dev/null || true
        
        # 验证产物是否存在
        ls -l "${{ github.workspace }}/ffmpeg-build-output/bin/"
        ls -l "${{ github.workspace }}/ffmpeg-build-output/lib/"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows-x64-shared-n5.1.4
        path: ${{ github.workspace }}/ffmpeg-build-output/
        retention-days: 90

    - name: Package Build Artifacts as ZIP
      run: |
        cd ${{ github.workspace }}/ffmpeg-build-output
        powershell Compress-Archive -Path * -DestinationPath ../ffmpeg-windows-x64-shared-n5.1.4.zip

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: n5.1.4-${{ github.run_number }}
        release_name: FFmpeg Windows Build v5.1.4 #${{ github.run_number }}
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ github.workspace }}/ffmpeg-windows-x64-shared-n5.1.4.zip
        asset_name: ffmpeg-windows-x64-shared-n5.1.4.zip
        asset_content_type: application/zip
