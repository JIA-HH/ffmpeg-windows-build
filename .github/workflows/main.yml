name: Build FFmpeg with MSVC

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release after build'
        required: false
        default: 'false'
        type: boolean

# 新增：提升GITHUB_TOKEN权限（解决Release创建权限问题）
permissions:
  contents: write
  actions: read

env:
  FFPEG_VERSION: 5.1.4
  # 统一路径（避免混合分隔符）
  WORKSPACE: ${{ github.workspace }}
  X264_INSTALL: ${{ github.workspace }}\x264-install
  FFMPEG_INSTALL: ${{ github.workspace }}\ffmpeg-install

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Cache MSYS2 Dependencies
      id: cache-msys2
      uses: actions/cache@v4
      with:
        path: C:\tools\msys64
        key: msys2-${{ runner.os }}-${{ hashFiles('**/msvc.yaml') }}
        restore-keys: |
          msys2-${{ runner.os }}-
          
    - name: Setup MSYS2 (仅用于依赖下载/辅助工具，不参与编译)
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: ${{ steps.cache-msys2.outputs.cache-hit != 'true' }}
        install: >-
          git
          make
          wget
          unzip
          sed
          pkg-config
          mingw-w64-x86_64-yasm
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-make
          mingw-w64-x86_64-pkg-config
      
    - name: Setup Visual Studio Environment (MSVC核心环境)
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        vsversion: 2022
        # 移除toolset参数，使用默认工具集
        
    - name: Cache MSVC编译依赖
      id: cache-msvc-deps
      uses: actions/cache@v4
      with:
        path: |
          C:\Program Files\NASM
          C:\Program Files\CMake
        key: msvc-deps-${{ runner.os }}-${{ hashFiles('**/msvc.yaml') }}
        restore-keys: |
          msvc-deps-${{ runner.os }}-
          
    - name: Install MSVC编译依赖
      if: steps.cache-msvc-deps.outputs.cache-hit != 'true'
      run: |
        # 安装nasm（MSVC编译FFmpeg必需）、cmake
        choco install nasm -y --no-progress
        choco install cmake -y --no-progress --install-arguments 'ADD_CMAKE_TO_PATH=System'
        # 刷新环境变量
        refreshenv
        
    - name: Cache x264 Source
      id: cache-x264-source
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKSPACE }}\x264
        key: x264-source-${{ runner.os }}-${{ hashFiles('**/msvc.yaml') }}
        restore-keys: |
          x264-source-${{ runner.os }}-
          
    - name: Clone x264 Source (适配MSVC编译)
      if: steps.cache-x264-source.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%
        rmdir /s /q x264 2>nul || true
        git clone --depth=1 https://code.videolan.org/videolan/x264.git x264
        cd x264 && git rev-parse --short HEAD && cd ..
        
    - name: Cache x264 Build
      id: cache-x264-build
      uses: actions/cache@v4
      with:
        path: ${{ env.X264_INSTALL }}
        key: x264-build-${{ runner.os }}-${{ hashFiles('**/msvc.yaml') }}
        restore-keys: |
          x264-build-${{ runner.os }}-
          
    - name: Build x264 with MSVC (关键修复：生成MSVC格式库)
      if: steps.cache-x264-build.outputs.cache-hit != 'true'
      shell: msys2 {0}
      run: |
        cd "$WORKSPACE/x264"
        
        # 清理旧产物
        make clean 2>/dev/null || true
        rm -rf build
        
        # 设置环境变量确保使用MinGW编译器
        export CC=x86_64-w64-mingw32-gcc
        export CXX=x86_64-w64-mingw32-g++
        
        # 使用MinGW构建x264，生成MSVC兼容的库
        ./configure \
          --prefix="$WORKSPACE/x264-install" \
          --host=x86_64-w64-mingw32 \
          --enable-shared \
          --enable-static \
          --extra-cflags="-O2" \
          --disable-asm \
          --extra-ldflags="-static-libgcc"
        
        # 编译并安装
        make -j$(nproc)
        make install
        
    - name: Cache FFmpeg Source
      id: cache-ffmpeg-source
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKSPACE }}\ffmpeg
        key: ffmpeg-source-n${{ env.FFPEG_VERSION }}-${{ runner.os }}-${{ hashFiles('**/msvc.yaml') }}
        restore-keys: |
          ffmpeg-source-n${{ env.FFPEG_VERSION }}-${{ runner.os }}-
          
    - name: Clone FFmpeg Source 
      if: steps.cache-ffmpeg-source.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%
        rmdir /s /q ffmpeg 2>nul || true
        git clone --depth=1 --branch=n%FFPEG_VERSION% https://github.com/FFmpeg/FFmpeg.git ffmpeg
        cd ffmpeg && git rev-parse --short HEAD && cd ..
        
    - name: Patch FFmpeg libm.h (修复数学函数定义)
      shell: msys2 {0}
      run: |
        cd $WORKSPACE/ffmpeg/libavutil
        # 备份原文件
        cp libm.h libm.h.bak
        # 彻底禁用内部数学函数（覆盖所有HAVE_xxx判断）
        sed -i 's/#if !HAVE_/#if 0 \/\/ disabled for MSVC - #if !HAVE_/g' libm.h
        sed -i 's/#elif !HAVE_/#elif 0 \/\/ disabled for MSVC - #elif !HAVE_/g' libm.h
        # 验证修改
        cat libm.h | grep -E "#if 0.*HAVE_" | head -5
        
    - name: Cache FFmpeg Build
      id: cache-ffmpeg-build
      uses: actions/cache@v4
      with:
        path: ${{ env.FFMPEG_INSTALL }}
        key: ffmpeg-build-n${{ env.FFPEG_VERSION }}-${{ runner.os }}-${{ hashFiles('**/msvc.yaml') }}
        restore-keys: |
          ffmpeg-build-n${{ env.FFPEG_VERSION }}-${{ runner.os }}-
          
    - name: Build FFmpeg with MSVC (核心修复：纯MSVC编译)
      if: steps.cache-ffmpeg-build.outputs.cache-hit != 'true'
      shell: msys2 {0}
      run: |
        cd "$WORKSPACE/ffmpeg"
        
        # 清理旧产物
        rm -f ffbuild/config.mak
        
        # 设置环境变量（纯MSVC）
        export CC=cl
        export CXX=cl
        export LD=link
        export AR=lib
        export RANLIB=echo
        export STRIP=echo
        # x264路径（MSYS格式）
        export INCLUDE="$X264_INSTALL/include;$INCLUDE"
        export LIB="$X264_INSTALL/lib;$LIB"
        # pkg-config路径（识别x264.pc）
        export PKG_CONFIG_PATH="$X264_INSTALL/lib/pkgconfig"
        
        # FFmpeg configure（纯MSVC参数，移除MinGW冲突项）
        ./configure \
          --prefix="$FFMPEG_INSTALL" \
          --target-os=win32 \
          --arch=x86_64 \
          --toolchain=msvc \
          --enable-gpl \
          --enable-version3 \
          --enable-shared \
          --disable-static \
          --enable-libx264 \
          --enable-w32threads \
          --enable-postproc \
          --enable-nonfree \
          --disable-programs \
          --disable-doc \
          --disable-asm \
          --extra-cflags="-MD -DHAVE_LRINT=1 -DHAVE_LRINTF=1 -DHAVE_RINT=1 -DHAVE_ROUND=1 -DHAVE_TRUNC=1 -DHAVE_CBRT=1 -DHAVE_ERF=1" \
          --extra-ldflags="-LIBPATH:$X264_INSTALL/lib"
        
        # 编译（MSVC多线程）
        make -j$(nproc)
        # 安装
        make install
        
    - name: Package Build Artifacts
      shell: cmd
      run: |
        :: 创建输出目录
        mkdir %WORKSPACE%\ffmpeg-build-output\bin 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\lib 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\include 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\licenses 2>nul || true
        
        :: 复制FFmpeg产物
        copy /Y %FFMPEG_INSTALL%\bin\*.dll %WORKSPACE%\ffmpeg-build-output\bin\
        copy /Y %FFMPEG_INSTALL%\lib\*.lib %WORKSPACE%\ffmpeg-build-output\lib\
        xcopy /E /Y %FFMPEG_INSTALL%\include\* %WORKSPACE%\ffmpeg-build-output\include\
        
        :: 复制x264产物（依赖）
        copy /Y %X264_INSTALL%\bin\*.dll %WORKSPACE%\ffmpeg-build-output\bin\
        copy /Y %X264_INSTALL%\lib\*.lib %WORKSPACE%\ffmpeg-build-output\lib\
        xcopy /E /Y %X264_INSTALL%\include\* %WORKSPACE%\ffmpeg-build-output\include\
        
        :: 复制许可证
        copy /Y %WORKSPACE%\ffmpeg\LICENSE.md %WORKSPACE%\ffmpeg-build-output\licenses\FFmpeg.txt 2>nul || true
        copy /Y %WORKSPACE%\x264\COPYING %WORKSPACE%\ffmpeg-build-output\licenses\x264.txt 2>nul || true
        
        :: 验证产物
        dir %WORKSPACE%\ffmpeg-build-output\bin
        dir %WORKSPACE%\ffmpeg-build-output\lib
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}
        path: ${{ env.WORKSPACE }}\ffmpeg-build-output\
        retention-days: 90
        
    - name: Package as ZIP
      shell: powershell
      run: |
        Compress-Archive -Path ${{ env.WORKSPACE }}\ffmpeg-build-output\* -DestinationPath ${{ env.WORKSPACE }}\ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}.zip -Force
        
    - name: Create Release (使用新版action，修复权限/废弃问题)
      id: create_release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: n${{ env.FFPEG_VERSION }}-${{ github.run_number }}
        name: FFmpeg Windows Build v${{ env.FFPEG_VERSION }}-${{ github.run_number }}
        draft: false
        prerelease: false
        files: ${{ env.WORKSPACE }}\ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}.zip
        body: |
          FFmpeg ${{ env.FFPEG_VERSION }} Windows build with:
          - MSVC 2022 toolchain (x64)
          - x264 support (MSVC build)
          - Shared libraries (DLL + LIB)
          - Headers for development
          
          ## Files included:
          - Binaries (DLLs)
          - MSVC import libraries (LIB)
          - Header files
          - Licenses
          
          ## Version Info
          - Build Number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
