name: Build FFmpeg with MSVC

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release after build'
        required: false
        default: 'false'
        type: boolean

env:
  FFPEG_VERSION: 5.1.4

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: false
        install: >-
          base-devel
          git
          make
          wget
          unzip
          yasm
      
    - name: Setup Visual Studio Environment
      uses: ilammy/msvc-dev-cmd@v1
      
    - name: Cache FFmpeg Source (n${{ env.FFPEG_VERSION }})
      id: cache-ffmpeg
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/ffmpeg
        key: ffmpeg-source-n${{ env.FFPEG_VERSION }}-${{ runner.os }}-${{ hashFiles('**/msvc-build.yaml') }}
        restore-keys: |
          ffmpeg-source-n${{ env.FFPEG_VERSION }}-${{ runner.os }}-
          
    - name: Clone FFmpeg Source (n${{ env.FFPEG_VERSION }})
      if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
      shell: msys2 {0}
      run: |
        cd $GITHUB_WORKSPACE
        git clone --depth=1 --branch=n${{ env.FFPEG_VERSION }} https://github.com/FFmpeg/FFmpeg.git ffmpeg
        # 验证版本是否正确
        cd ffmpeg && git rev-parse --short HEAD && cd ..
        
    - name: Install Dependencies
      run: |
        choco install nasm -y
        choco install pkgconfiglite -y
        
    - name: Cache x264 Source
      id: cache-x264
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/x264
        key: x264-source-${{ runner.os }}-${{ hashFiles('**/msvc-build.yaml') }}
        restore-keys: |
          x264-source-${{ runner.os }}-
          
    - name: Clone x264 Source
      if: steps.cache-x264.outputs.cache-hit != 'true'
      shell: msys2 {0}
      run: |
        cd $GITHUB_WORKSPACE
        git clone --depth=1 https://code.videolan.org/videolan/x264.git x264
        # 验证克隆是否成功
        cd x264 && git rev-parse --short HEAD && cd ..
        
    - name: Build x264
      shell: msys2 {0}
      run: |
        cd $GITHUB_WORKSPACE/x264
        
        # Configure and build x264
        ./configure \
          --prefix="${{ github.workspace }}/x264-install" \
          --host=x86_64-w64-mingw32 \
          --enable-static \
          --enable-shared
          
        make -j$(nproc)
        make install
        
    - name: Build FFmpeg with MSVC
      run: |
        cd "${{ github.workspace }}/ffmpeg"
        
        # 清理旧编译产物
        make clean || true
        
        # MSVC 配置
        ./configure \
          --prefix="${{ github.workspace }}/ffmpeg-install" \
          --target-os=win32 \
          --arch=x86_64 \
          --toolchain=msvc \
          --enable-cross-compile \
          --enable-gpl \
          --enable-version3 \
          --enable-shared \
          --enable-static \
          --enable-libx264 \
          --extra-cflags="-I${{ github.workspace }}/x264-install/include" \
          --extra-ldflags="-L${{ github.workspace }}/x264-install/lib" \
          --pkg-config-flags="--static" \
          --enable-w32threads \
          --enable-postproc \
          --enable-nonfree \
          --disable-programs \
          --disable-doc \
          --extra-cflags="-MD" \
          --enable-pic \
          --extra-ldexeflags="-static-libgcc"
        
        # 编译
        make -j${{ env.NUMBER_OF_PROCESSORS }}
        
        # 安装
        make install
        
    - name: Package Build Artifacts
      shell: msys2 {0}
      run: |
        # 创建标准化输出目录
        mkdir -p "${{ github.workspace }}/ffmpeg-build-output/bin"
        mkdir -p "${{ github.workspace }}/ffmpeg-build-output/lib"
        mkdir -p "${{ github.workspace }}/ffmpeg-build-output/include"
        mkdir -p "${{ github.workspace }}/ffmpeg-build-output/licenses"
        
        # 复制编译产物
        cp -f "${{ github.workspace }}/ffmpeg-install/bin/"*.dll "${{ github.workspace }}/ffmpeg-build-output/bin/" 2>/dev/null || true
        cp -f "${{ github.workspace }}/ffmpeg-install/lib/"*.lib "${{ github.workspace }}/ffmpeg-build-output/lib/" 2>/dev/null || true
        cp -f "${{ github.workspace }}/ffmpeg-install/lib/"*.dll.a "${{ github.workspace }}/ffmpeg-build-output/lib/" 2>/dev/null || true
        cp -r "${{ github.workspace }}/ffmpeg-install/include/"* "${{ github.workspace }}/ffmpeg-build-output/include/" 2>/dev/null || true
        
        # 复制 x264 库文件
        cp -f "${{ github.workspace }}/x264-install/bin/"*.dll "${{ github.workspace }}/ffmpeg-build-output/bin/" 2>/dev/null || true
        cp -f "${{ github.workspace }}/x264-install/lib/"*.lib "${{ github.workspace }}/ffmpeg-build-output/lib/" 2>/dev/null || true
        cp -f "${{ github.workspace }}/x264-install/lib/"*.dll.a "${{ github.workspace }}/ffmpeg-build-output/lib/" 2>/dev/null || true
        cp -r "${{ github.workspace }}/x264-install/include/"* "${{ github.workspace }}/ffmpeg-build-output/include/" 2>/dev/null || true
        
        # 复制许可证文件
        cp "${{ github.workspace }}/ffmpeg/LICENSE.md" "${{ github.workspace }}/ffmpeg-build-output/licenses/FFmpeg.txt" 2>/dev/null || true
        cp "${{ github.workspace }}/x264/COPYING" "${{ github.workspace }}/ffmpeg-build-output/licenses/x264.txt" 2>/dev/null || true
        
        # 验证产物是否存在
        ls -l "${{ github.workspace }}/ffmpeg-build-output/bin/"
        ls -l "${{ github.workspace }}/ffmpeg-build-output/lib/"
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}
        path: ${{ github.workspace }}/ffmpeg-build-output/
        retention-days: 90
        
    - name: Package Build Artifacts as ZIP
      run: |
        cd "${{ github.workspace }}/ffmpeg-build-output"
        powershell Compress-Archive -Path * -DestinationPath ../ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}.zip
        
    - name: Create Release
      id: create_release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: n${{ env.FFPEG_VERSION }}-${{ github.run_number }}
        release_name: FFmpeg Windows Build v${{ env.FFPEG_VERSION }}-${{ github.run_number }}
        draft: false
        prerelease: false
        body: |
          FFmpeg ${{ env.FFPEG_VERSION }} Windows build with:
          - MSVC toolchain
          - x264 support
          - Shared libraries
          - Static libraries
          - Headers for development
          
          ## Files included:
          - Binaries (DLLs and EXEs)
          - Libraries (LIB and DLL.A files)
          - Header files for development
          - Licenses for included components
          
          ## Version Information
          - Build Number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
          
    - name: Upload Release Asset
      if: steps.create_release.outputs.upload_url
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ github.workspace }}/ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}.zip
        asset_name: ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}.zip
        asset_content_type: application/zip
