name: Build FFmpeg with MSVC

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release after build'
        required: false
        default: 'false'
        type: boolean

env:
  FFPEG_VERSION: 5.1.4

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          base-devel
          git
          make
          wget
          unzip
          yasm
          gcc
          pkg-config
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-make
          mingw-w64-x86_64-pkg-config
      
    - name: Setup Visual Studio Environment
      uses: ilammy/msvc-dev-cmd@v1
      
    - name: Cache FFmpeg Source 
      id: cache-ffmpeg
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/ffmpeg
        key: ffmpeg-source-n${{ env.FFPEG_VERSION }}-${{ runner.os }}-${{ hashFiles('**/msvc-build.yaml') }}
        restore-keys: |
          ffmpeg-source-n${{ env.FFPEG_VERSION }}-${{ runner.os }}-
          
    - name: Clone FFmpeg Source 
      if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
      shell: msys2 {0}
      run: |
        cd $GITHUB_WORKSPACE
        # 如果目录不存在或者为空，则进行克隆
        if [ ! -d "ffmpeg" ] || [ -z "$(ls -A ffmpeg)" ]; then
          rm -rf ffmpeg
          git clone --depth=1 --branch=n${{ env.FFPEG_VERSION }} https://github.com/FFmpeg/FFmpeg.git ffmpeg
          # 验证版本是否正确
          cd ffmpeg && git rev-parse --short HEAD && cd ..
        else
          echo "FFmpeg source directory already exists, skipping clone"
        fi
        
    - name: Install Dependencies
      run: |
        choco install nasm -y
        choco install pkgconfiglite -y
        
    - name: Cache x264 Source
      id: cache-x264
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/x264
        key: x264-source-${{ runner.os }}-${{ hashFiles('**/msvc-build.yaml') }}
        restore-keys: |
          x264-source-${{ runner.os }}-
          
    - name: Clone x264 Source
      if: steps.cache-x264.outputs.cache-hit != 'true'
      shell: msys2 {0}
      run: |
        cd $GITHUB_WORKSPACE
        # 如果目录不存在或者为空，则进行克隆
        if [ ! -d "x264" ] || [ -z "$(ls -A x264)" ]; then
          rm -rf x264
          git clone --depth=1 https://code.videolan.org/videolan/x264.git x264
          # 验证克隆是否成功
          cd x264 && git rev-parse --short HEAD && cd ..
        else
          echo "x264 source directory already exists, skipping clone"
        fi
        
    - name: Cache x264 Build
      id: cache-x264-build
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/x264-install
        key: x264-build-${{ runner.os }}-${{ hashFiles('**/msvc-build.yaml') }}
        restore-keys: |
          x264-build-${{ runner.os }}-
          
    - name: Build x264 with MSVC
      if: steps.cache-x264-build.outputs.cache-hit != 'true'
      continue-on-error: true
      shell: msys2 {0}
      run: |
        cd $GITHUB_WORKSPACE/x264
        
        # 使用MinGW构建x264，因为我们需要与MSVC兼容的库
        ./configure \
          --prefix="${{ github.workspace }}/x264-install" \
          --host=x86_64-w64-mingw32 \
          --enable-static \
          --enable-shared \
          --extra-cflags="-O2" \
          --disable-asm \
          --extra-ldflags="-static-libgcc"
          
        make -j$(nproc)
        make install
        
    - name: Cache FFmpeg Build
      id: cache-ffmpeg-build
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/ffmpeg-install
        key: ffmpeg-build-n${{ env.FFPEG_VERSION }}-${{ runner.os }}-${{ hashFiles('**/msvc-build.yaml') }}
        restore-keys: |
          ffmpeg-build-n${{ env.FFPEG_VERSION }}-${{ runner.os }}-
          
    - name: Build FFmpeg with MSVC
      if: steps.cache-ffmpeg-build.outputs.cache-hit != 'true'
      continue-on-error: true
      shell: powershell
      run: |
        # 设置MSVC环境变量
        $env:CC = "cl"
        $env:CXX = "cl"
        $env:LD = "link"
        $env:AR = "lib"
        $env:RANLIB = "echo" 
        $env:STRIP = "echo"
        
        # 设置x264库路径
        $env:LIB = "${{ github.workspace }}\x264-install\lib;" + $env:LIB
        $env:INCLUDE = "${{ github.workspace }}\x264-install\include;" + $env:INCLUDE
        
        cd "${{ github.workspace }}/ffmpeg"
        
        # 修改libavutil/libm.h文件，禁用内部数学函数实现
        if (Test-Path "libavutil/libm.h") {
          # 先备份原文件
          Copy-Item "libavutil/libm.h" "libavutil/libm.h.bak" -Force
          
          # 直接使用PowerShell逐行处理，确保精确替换
          $lines = Get-Content "libavutil/libm.h"
          $newLines = @()
          
          foreach ($line in $lines) {
            # 检查是否是我们要修改的行
            if ($line -match '^\s*#\s*if\s+!\s*HAVE_\w+$') {
              # 替换为 #if 0
              $newLines += "#if 0"
            } else {
              # 保留原行
              $newLines += $line
            }
          }
          
          # 写入修改后的内容
          $newLines | Set-Content "libavutil/libm.h" -Encoding UTF8
          
          Write-Host "Modified libavutil/libm.h to disable internal math functions"
          
          # 验证修改是否正确
          $invalidLines = Select-String -Path "libavutil/libm.h" -Pattern "#if 0[A-Z]" -AllMatches
          if ($invalidLines) {
            Write-Host "Error: Found invalid patterns after replacement:"
            $invalidLines | ForEach-Object { Write-Host $_.Line }
            Write-Host "Restoring backup file"
            Copy-Item "libavutil/libm.h.bak" "libavutil/libm.h" -Force
            exit 1
          }
        }
        
        # 使用bash执行configure和make命令
        bash -c @"
          # 清理旧编译产物
          make clean || true
          
          # MSVC 配置
          ./configure \
            --prefix='${{ github.workspace }}/ffmpeg-install' \
            --target-os=win32 \
            --arch=x86_64 \
            --toolchain=msvc \
            --enable-cross-compile \
            --enable-gpl \
            --enable-version3 \
            --enable-shared \
            --enable-static \
            --enable-libx264 \
            --extra-cflags='-I${{ github.workspace }}/x264-install/include -DHAVE_LRINT=1 -DHAVE_LRINTF=1 -DHAVE_RINT=1 -DHAVE_ROUND=1 -DHAVE_TRUNC=1 -DHAVE_CBRT=1 -DHAVE_ERF=1' \
            --extra-ldflags='-L${{ github.workspace }}/x264-install/lib' \
            --pkg-config-flags='--static' \
            --enable-w32threads \
            --enable-postproc \
            --enable-nonfree \
            --disable-programs \
            --disable-doc \
            --extra-cflags='-MD'
            
          # 编译
          make -j$(nproc)
          
          # 安装
          make install
        "@
        
    - name: Package Build Artifacts
      if: always()
      shell: msys2 {0}
      run: |
        # 创建标准化输出目录
        mkdir -p "${{ github.workspace }}/ffmpeg-build-output/bin"
        mkdir -p "${{ github.workspace }}/ffmpeg-build-output/lib"
        mkdir -p "${{ github.workspace }}/ffmpeg-build-output/include"
        mkdir -p "${{ github.workspace }}/ffmpeg-build-output/licenses"
        
        # 复制编译产物
        cp -f "${{ github.workspace }}/ffmpeg-install/bin/"*.dll "${{ github.workspace }}/ffmpeg-build-output/bin/" 2>/dev/null || true
        cp -f "${{ github.workspace }}/ffmpeg-install/lib/"*.lib "${{ github.workspace }}/ffmpeg-build-output/lib/" 2>/dev/null || true
        cp -f "${{ github.workspace }}/ffmpeg-install/lib/"*.dll.a "${{ github.workspace }}/ffmpeg-build-output/lib/" 2>/dev/null || true
        cp -r "${{ github.workspace }}/ffmpeg-install/include/"* "${{ github.workspace }}/ffmpeg-build-output/include/" 2>/dev/null || true
        
        # 复制 x264 库文件
        cp -f "${{ github.workspace }}/x264-install/bin/"*.dll "${{ github.workspace }}/ffmpeg-build-output/bin/" 2>/dev/null || true
        cp -f "${{ github.workspace }}/x264-install/lib/"*.lib "${{ github.workspace }}/ffmpeg-build-output/lib/" 2>/dev/null || true
        cp -f "${{ github.workspace }}/x264-install/lib/"*.dll.a "${{ github.workspace }}/ffmpeg-build-output/lib/" 2>/dev/null || true
        cp -r "${{ github.workspace }}/x264-install/include/"* "${{ github.workspace }}/ffmpeg-build-output/include/" 2>/dev/null || true
        
        # 复制许可证文件
        cp "${{ github.workspace }}/ffmpeg/LICENSE.md" "${{ github.workspace }}/ffmpeg-build-output/licenses/FFmpeg.txt" 2>/dev/null || true
        cp "${{ github.workspace }}/x264/COPYING" "${{ github.workspace }}/ffmpeg-build-output/licenses/x264.txt" 2>/dev/null || true
        
        # 验证产物是否存在
        ls -l "${{ github.workspace }}/ffmpeg-build-output/bin/"
        ls -l "${{ github.workspace }}/ffmpeg-build-output/lib/"
        
    - name: Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}
        path: ${{ github.workspace }}/ffmpeg-build-output/
        retention-days: 90
        
    - name: Package Build Artifacts as ZIP
      run: |
        cd "${{ github.workspace }}/ffmpeg-build-output"
        powershell Compress-Archive -Path * -DestinationPath ../ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}.zip
        
    - name: Create Release
      id: create_release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: n${{ env.FFPEG_VERSION }}-${{ github.run_number }}
        release_name: FFmpeg Windows Build v${{ env.FFPEG_VERSION }}-${{ github.run_number }}
        draft: false
        prerelease: false
        body: |
          FFmpeg ${{ env.FFPEG_VERSION }} Windows build with:
          - MSVC toolchain
          - x264 support
          - Shared libraries
          - Static libraries
          - Headers for development
          
          ## Files included:
          - Binaries (DLLs and EXEs)
          - Libraries (LIB and DLL.A files)
          - Header files for development
          - Licenses for included components
          
          ## Version Information
          - Build Number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
          
    - name: Upload Release Asset
      if: steps.create_release.outputs.upload_url
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ github.workspace }}/ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}.zip
        asset_name: ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}.zip
        asset_content_type: application/zip
