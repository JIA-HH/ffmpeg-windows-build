name: FFmpeg Windows Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}  # 全局默认使用msys2 shell，简化命令

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    # 缓存FFmpeg源码，避免每次重复克隆（核心优化）
    - name: Cache FFmpeg Source (n5.1.4)
      id: cache-ffmpeg
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/ffmpeg
        key: ffmpeg-source-n5.1.4-${{ runner.os }}
        restore-keys: |
          ffmpeg-source-n5.1.4-

    # 仅缓存未命中时克隆源码（第一次运行/版本变更时执行）
    - name: Clone FFmpeg Source (n5.1.4)
      if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
      run: |
        cd $GITHUB_WORKSPACE
        git clone --depth=1 --branch=n5.1.4 https://github.com/FFmpeg/FFmpeg.git ffmpeg
        # 验证版本是否正确
        cd ffmpeg && git rev-parse --short HEAD && cd ..

    - name: Set up MSYS2 & Install Dependencies
      uses: msys2/setup-msys2@v2
      with:
        msystem: mingw64
        update: true
        install: >-
          base-devel
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-nasm
          mingw-w64-x86_64-yasm
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-libx264
          mingw-w64-x86_64-libx265
          mingw-w64-x86_64-libvorbis
          mingw-w64-x86_64-lame
          mingw-w64-x86_64-avisynthplus
          git
          pkg-config

    - name: Build FFmpeg
      run: |
        cd $GITHUB_WORKSPACE/ffmpeg
        
        # 清理旧编译产物（避免缓存干扰）
        make clean || true
        
        # 配置构建选项（修复协议冲突、规范参数）
        ./configure \
          --prefix=${{ github.workspace }}/ffmpeg-install \  # 输出到工作目录，避免系统目录权限问题
          --target-os=mingw32 \
          --arch=x86_64 \
          --enable-gpl \
          --enable-version3 \
          --enable-shared \
          --disable-static \
          --enable-libx264 \
          --enable-libx265 \
          --enable-pthreads \
          --enable-w32threads \
          --enable-postproc \
          --enable-avisynth \
          --enable-libvorbis \
          --enable-libmp3lame \
          --enable-nonfree \  # 解决libfdk-aac（若启用）或x264/x265的GPL协议冲突
          --disable-programs \  # 可选：仅编译库，不编译ffmpeg/ffplay等可执行文件
          --disable-doc \       # 可选：禁用文档，加速编译
          --extra-cflags=-I/mingw64/include \
          --extra-ldflags=-L/mingw64/lib
        
        # 编译（自动适配CPU核心数）
        make -j$(nproc)
        
        # 安装到指定目录
        make install

    - name: Package Build Artifacts
      run: |
        # 创建标准化输出目录
        mkdir -p ${{ github.workspace }}/ffmpeg-build-output/{bin,lib,include}
        
        # 复制编译产物（从自定义安装目录复制，避免系统目录依赖）
        cp -f ${{ github.workspace }}/ffmpeg-install/bin/*.dll ${{ github.workspace }}/ffmpeg-build-output/bin/
        cp -f ${{ github.workspace }}/ffmpeg-install/bin/*.exe ${{ github.workspace }}/ffmpeg-build-output/bin/  # 若启用了programs则保留
        cp -f ${{ github.workspace }}/ffmpeg-install/lib/*.lib ${{ github.workspace }}/ffmpeg-build-output/lib/
        cp -f ${{ github.workspace }}/ffmpeg-install/lib/*.dll.a ${{ github.workspace }}/ffmpeg-build-output/lib/  # MinGW导入库
        cp -r ${{ github.workspace }}/ffmpeg-install/include/* ${{ github.workspace }}/ffmpeg-build-output/include/
        
        # 验证产物是否存在
        ls -l ${{ github.workspace }}/ffmpeg-build-output/bin/
        ls -l ${{ github.workspace }}/ffmpeg-build-output/lib/

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows-x64-shared-n5.1.4
        path: ${{ github.workspace }}/ffmpeg-build-output/
        retention-days: 90  # 产物保留30天，可按需调整
