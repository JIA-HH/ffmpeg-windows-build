name: MSVC

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release after build'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  actions: read

env:
  FFPEG_VERSION: 5.1.4
  WORKSPACE: ${{ github.workspace }}
  X264_INSTALL: ${{ github.workspace }}\x264-install
  FFMPEG_INSTALL: ${{ github.workspace }}\ffmpeg-install
  CACHE_HASH_FILE: ${{ github.workspace }}/.github/workflows/ffmpeg-msvc.yml

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Cache MSYS2 Dependencies
      id: cache-msys2
      uses: actions/cache@v4
      with:
        path: ${{ runner.temp }}/msys64
        key: msys2-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          msys2-${{ runner.os }}-
          
    # 核心修复：MSYS2包名+移除注释
    - name: Setup MSYS2 (仅辅助工具)
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: ${{ steps.cache-msys2.outputs.cache-hit != 'true' }}
        install: >-
          git make wget unzip sed pkg-config mingw-w64-x86_64-yasm mingw-w64-x86_64-flex mingw-w64-x86_64-bison
      
    - name: Setup Visual Studio Environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        vsversion: 2022
        toolset: 14.38
        spectre: false
        
    - name: Cache MSVC编译依赖
      id: cache-msvc-deps
      uses: actions/cache@v4
      with:
        path: |
          C:\Program Files\NASM
          C:\Program Files\CMake
        key: msvc-deps-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          msvc-deps-${{ runner.os }}-
          
    - name: Install MSVC编译依赖
      if: steps.cache-msvc-deps.outputs.cache-hit != 'true'
      run: |
        choco install nasm -y --no-progress
        choco install cmake -y --no-progress --install-arguments 'ADD_CMAKE_TO_PATH=System'
        refreshenv
        
    - name: Cache x264 Source
      id: cache-x264-source
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKSPACE }}\x264
        key: x264-source-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          x264-source-${{ runner.os }}-
          
    - name: Clone x264 Source
      if: steps.cache-x264-source.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%
        rmdir /s /q x264 2>nul || true
        git clone --depth=1 https://code.videolan.org/videolan/x264.git x264
        cd x264 && git rev-parse --short HEAD && cd ..
        
    - name: Cache x264 Build
      id: cache-x264-build
      uses: actions/cache@v4
      with:
        path: ${{ env.X264_INSTALL }}
        key: x264-build-msvc-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          x264-build-msvc-${{ runner.os }}-
          
    - name: Build x264 with MSVC
      if: steps.cache-x264-build.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%\x264
        rmdir /s /q build 2>nul || true
        mkdir build && cd build
        
        cmake .. -G "Visual Studio 17 2022" -A x64 ^
          -DCMAKE_INSTALL_PREFIX=%X264_INSTALL% ^
          -DENABLE_SHARED=ON ^
          -DENABLE_STATIC=OFF ^
          -DENABLE_ASM=OFF ^
          -DCMAKE_BUILD_TYPE=Release
        
        cmake --build . --config Release --target install -j %NUMBER_OF_PROCESSORS%
        
    - name: Cache FFmpeg Source
      id: cache-ffmpeg-source
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKSPACE }}\ffmpeg
        key: ffmpeg-source-n${{ env.FFPEG_VERSION }}-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          ffmpeg-source-n${{ env.FFPEG_VERSION }}-${{ runner.os }}-
          
    - name: Clone FFmpeg Source 
      if: steps.cache-ffmpeg-source.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%
        rmdir /s /q ffmpeg 2>nul || true
        git clone --depth=1 --branch=n%FFPEG_VERSION% https://github.com/FFmpeg/FFmpeg.git ffmpeg
        cd ffmpeg && git rev-parse --short HEAD && cd ..
        
    - name: Patch FFmpeg libm.h
      shell: msys2 {0}
      run: |
        cd $WORKSPACE/ffmpeg/libavutil
        cp libm.h libm.h.bak
        sed -i 's/#if !HAVE_/#if 0 \/\/ disabled for MSVC - #if !HAVE_/g' libm.h
        sed -i 's/#elif !HAVE_/#elif 0 \/\/ disabled for MSVC - #elif !HAVE_/g' libm.h
        cat libm.h | grep -E "#if 0.*HAVE_" | head -5
        
    - name: Cache FFmpeg Build
      id: cache-ffmpeg-build
      uses: actions/cache@v4
      with:
        path: ${{ env.FFMPEG_INSTALL }}
        key: ffmpeg-build-n${{ env.FFPEG_VERSION }}-msvc-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          ffmpeg-build-n${{ env.FFPEG_VERSION }}-msvc-${{ runner.os }}-
          
    - name: Build FFmpeg with MSVC
      if: steps.cache-ffmpeg-build.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%\ffmpeg
        del ffbuild\config.mak 2>nul || true
        
        set CC=cl
        set CXX=cl
        set LD=link
        set AR=lib
        set RANLIB=echo
        set STRIP=echo
        
        set INCLUDE=%X264_INSTALL%\include;%INCLUDE%
        set LIB=%X264_INSTALL%\lib;%LIB%
        set PKG_CONFIG_PATH=%X264_INSTALL%\lib\pkgconfig
        
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
        
        ./configure ^
          --prefix=%FFMPEG_INSTALL% ^
          --target-os=win32 ^
          --arch=x86_64 ^
          --toolchain=msvc ^
          --enable-gpl ^
          --enable-version3 ^
          --enable-shared ^
          --disable-static ^
          --enable-libx264 ^
          --enable-w32threads ^
          --enable-postproc ^
          --enable-nonfree ^
          --disable-programs ^
          --disable-doc ^
          --disable-asm ^
          --extra-cflags="-MD -DHAVE_LRINT=1 -DHAVE_LRINTF=1 -DHAVE_RINT=1 -DHAVE_ROUND=1 -DHAVE_TRUNC=1 -DHAVE_CBRT=1 -DHAVE_ERF=1" ^
          --extra-ldflags="-LIBPATH:%X264_INSTALL%\lib"
        
        if not exist ffbuild\config.mak (
          echo ERROR: Configure failed - config.mak not found
          dir ffbuild
          exit 1
        )
        
        make -j %NUMBER_OF_PROCESSORS%
        make install
        
    - name: Package Build Artifacts
      shell: cmd
      run: |
        mkdir %WORKSPACE%\ffmpeg-build-output\bin 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\lib 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\include 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\licenses 2>nul || true
        
        copy /Y %FFMPEG_INSTALL%\bin\*.dll %WORKSPACE%\ffmpeg-build-output\bin\
        copy /Y %FFMPEG_INSTALL%\lib\*.lib %WORKSPACE%\ffmpeg-build-output\lib\
        xcopy /E /Y %FFMPEG_INSTALL%\include\* %WORKSPACE%\ffmpeg-build-output\include\
        
        copy /Y %X264_INSTALL%\bin\*.dll %WORKSPACE%\ffmpeg-build-output\bin\
        copy /Y %X264_INSTALL%\lib\*.lib %WORKSPACE%\ffmpeg-build-output\lib\
        xcopy /E /Y %X264_INSTALL%\include\* %WORKSPACE%\ffmpeg-build-output\include\
        
        copy /Y %WORKSPACE%\ffmpeg\LICENSE.md %WORKSPACE%\ffmpeg-build-output\licenses\FFmpeg.txt 2>nul || true
        copy /Y %WORKSPACE%\x264\COPYING %WORKSPACE%\ffmpeg-build-output\licenses\x264.txt 2>nul || true
        
        dir %WORKSPACE%\ffmpeg-build-output\bin
        dir %WORKSPACE%\ffmpeg-build-output\lib
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}
        path: ${{ env.WORKSPACE }}\ffmpeg-build-output\
        retention-days: 90
        
    - name: Package as ZIP
      shell: powershell
      run: |
        Compress-Archive -Path ${{ env.WORKSPACE }}\ffmpeg-build-output\* -DestinationPath ${{ env.WORKSPACE }}\ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}.zip -Force
        
    - name: Create Release
      id: create_release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: n${{ env.FFPEG_VERSION }}-${{ github.run_number }}
        name: FFmpeg Windows Build v${{ env.FFPEG_VERSION }}-${{ github.run_number }}
        draft: false
        prerelease: false
        files: ${{ env.WORKSPACE }}\ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}.zip
        body: |
          FFmpeg ${{ env.FFPEG_VERSION }} Windows build with:
          - MSVC 2022 (v14.38) toolchain (x64)
          - x264 support (PURE MSVC build)
          - Shared libraries (DLL + MSVC import LIB)
          - Headers for development
          
          ## Files included:
          - Binaries (MSVC-compiled DLLs)
          - MSVC import libraries (.lib)
          - Header files
          - Licenses
          
          ## Version Info
          - Build Number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
