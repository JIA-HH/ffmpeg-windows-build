name: FFmpeg with MSVC

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release after build'
        required: false
        default: 'true'
        type: boolean
      build_x264:
        description: 'Build x264 support (default: false)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  actions: read

env:
  FFMPEG_VERSION: 5.1.4
  WORKSPACE: ${{ github.workspace }}
  X264_INSTALL: ${{ github.workspace }}\x264-install
  FFMPEG_INSTALL: ${{ github.workspace }}\ffmpeg-install
  # 缓存哈希基准文件（修改脚本时缓存自动更新）
  CACHE_HASH_FILE: ${{ github.workspace }}/.github/workflows/ffmpeg-msvc.yml

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # ========== 环境设置 ==========
    
    # MSYS2 缓存和辅助工具设置
    - name: Cache MSYS2 Dependencies
      id: cache-msys2
      uses: actions/cache@v4
      with:
        path: ${{ runner.temp }}/msys64
        key: msys2-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          msys2-${{ runner.os }}-
          
    - name: Setup MSYS2 (仅辅助工具，无MinGW编译依赖)
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: ${{ steps.cache-msys2.outputs.cache-hit != 'true' }}
        install: >-
          git
          make
          wget
          unzip
          sed
          pkg-config
          mingw-w64-x86_64-yasm
          flex
          bison

    # MSVC 环境设置
    - name: Setup Visual Studio Environment (纯MSVC核心环境)
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        vsversion: 2022
        spectre: false

    # MSVC 编译依赖缓存和安装
    - name: Cache MSVC编译依赖
      id: cache-msvc-deps
      uses: actions/cache@v4
      with:
        path: |
          C:\Program Files\NASM
          C:\Program Files\CMake
        key: msvc-deps-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          msvc-deps-${{ runner.os }}-
          
    - name: Install MSVC编译依赖
      if: steps.cache-msvc-deps.outputs.cache-hit != 'true'
      run: |
        choco install nasm -y --no-progress
        choco install cmake -y --no-progress --install-arguments 'ADD_CMAKE_TO_PATH=System'
        refreshenv  # 刷新环境变量，确保nasm/cmake可用
        
    # ========== x264 纯MSVC编译 (可选) ==========
    
    # x264 源码缓存
    - name: Cache x264 Source
      id: cache-x264-source
      if: github.event.inputs.build_x264 == 'true'
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKSPACE }}\x264
        key: x264-source-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          x264-source-${{ runner.os }}-

    # x264 源码下载
    - name: Clone x264 Source
      if: steps.cache-x264-source.outputs.cache-hit != 'true' && github.event.inputs.build_x264 == 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%
        rmdir /s /q x264 2>nul || true
        git clone --depth=1 https://code.videolan.org/videolan/x264.git x264
        cd x264 && git rev-parse --short HEAD && cd ..

    # x264 编译产物缓存
    - name: Cache x264 Build
      id: cache-x264-build
      if: github.event.inputs.build_x264 == 'true'
      uses: actions/cache@v4
      with:
        path: ${{ env.X264_INSTALL }}
        key: x264-build-msvc-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          x264-build-msvc-${{ runner.os }}-

    # x264 编译构建
    - name: Build x264 with MSVC
      if: steps.cache-x264-build.outputs.cache-hit != 'true' && github.event.inputs.build_x264 == 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%\x264
        
        :: 清理之前的配置
        del config.mak 2>nul || true
        
        :: 使用MSVC编译x264
        bash -c "./configure --prefix='%X264_INSTALL%' --enable-shared --enable-win32thread --disable-cli --toolchain=msvc"
        
        :: 编译和安装
        make -j%NUMBER_OF_PROCESSORS%
        make install
        
    # ========== FFmpeg 纯MSVC编译 ==========
    
    # FFmpeg 源码缓存
    - name: Cache FFmpeg Source
      id: cache-ffmpeg-source
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKSPACE }}\ffmpeg
        key: ffmpeg-source-n${{ env.FFMPEG_VERSION }}-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          ffmpeg-source-n${{ env.FFMPEG_VERSION }}-${{ runner.os }}-

    # FFmpeg 源码下载
    - name: Clone FFmpeg Source 
      if: steps.cache-ffmpeg-source.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%
        rmdir /s /q ffmpeg 2>nul || true
        git clone --depth=1 --branch=n%FFMPEG_VERSION% https://github.com/FFmpeg/FFmpeg.git ffmpeg
        cd ffmpeg && git rev-parse --short HEAD && cd ..

    # FFmpeg 数学函数兼容性修复
    - name: Patch FFmpeg libm.h
      shell: msys2 {0}
      run: |
        cd $WORKSPACE/ffmpeg/libavutil
        cp libm.h libm.h.bak
        sed -i 's/#if !HAVE_/#if 0 \/\/ disabled for MSVC - #if !HAVE_/g' libm.h
        sed -i 's/#elif !HAVE_/#elif 0 \/\/ disabled for MSVC - #elif !HAVE_/g' libm.h
        cat libm.h | grep -E "#if 0.*HAVE_" | head -5

    # FFmpeg 编译产物缓存
    - name: Cache FFmpeg Build
      id: cache-ffmpeg-build
      uses: actions/cache@v4
      with:
        path: ${{ env.FFMPEG_INSTALL }}
        key: ffmpeg-build-n${{ env.FFMPEG_VERSION }}-msvc-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          ffmpeg-build-n${{ env.FFMPEG_VERSION }}-msvc-${{ runner.os }}-

    # FFmpeg 核心编译
    - name: Build FFmpeg with MSVC (纯MSVC工具链)
      if: steps.cache-ffmpeg-build.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%\ffmpeg
        
        :: 清理之前的配置
        del ffbuild\config.mak 2>nul || true
        del ffbuild\config.h 2>nul || true
        del config.log 2>nul || true
        
        :: 验证编译器环境
        echo 验证编译器环境:
        where cl
        cl 2>&1 | findstr /C:"Microsoft" >nul && echo MSVC编译器已正确设置 || echo MSVC编译器设置失败
        
        :: 创建config.h文件
        echo 创建config.h文件...
        (
            echo /* FFmpeg MSVC Configuration Header */
            echo #ifndef FFMPEG_CONFIG_H
            echo #define FFMPEG_CONFIG_H
            echo #define FFMPEG_CONFIGURATION ""
            echo #define FFMPEG_LICENSE "LGPL version 2.1 or later"
            echo #define THIS_YEAR 2024
            echo #define CC_IDENT "msvc"
            echo #define OS_NAME win32
            echo #define HAVE_AV_CONFIG_H 1
            echo #define ARCH_X86_64 1
            echo #define HAVE_INLINE_ASM 0
            echo #define HAVE_SYMVER 0
            echo #define HAVE_X86ASM 0
            echo #define restrict __restrict
            echo #define inline __inline
            echo #define CONFIG_SHARED 1
            echo #define CONFIG_STATIC 0
            echo #define CONFIG_AVUTIL 1
            echo #define CONFIG_AVCODEC 1
            echo #define CONFIG_AVFORMAT 1
            echo #define CONFIG_SWSCALE 1
            echo #define CONFIG_SWRESAMPLE 1
            echo #define CONFIG_AVFILTER 1
            echo #define CONFIG_AVDEVICE 1
            echo #define CONFIG_POSTPROC 0
            echo #define CONFIG_FFMPEG 0
            echo #define CONFIG_FFPLAY 0
            echo #define CONFIG_FFPROBE 0
            echo #define CONFIG_DOC 0
            echo #define CONFIG_H264_DECODER 1
            echo #define CONFIG_H264_PARSER 1
            echo #define CONFIG_MOV_DEMUXER 1
            echo #define CONFIG_MP4_DEMUXER 1
            echo #define CONFIG_MATROSKA_DEMUXER 1
            echo #define CONFIG_AVI_DEMUXER 1
            echo #define CONFIG_FLV_DEMUXER 1
            echo #define CONFIG_MPEGTS_DEMUXER 1
            echo #define CONFIG_FILE_PROTOCOL 1
            echo #define CONFIG_HTTP_PROTOCOL 0
            echo #define CONFIG_HTTPS_PROTOCOL 0
            echo #define CONFIG_TCP_PROTOCOL 0
            echo #define CONFIG_UDP_PROTOCOL 0
            echo #define CONFIG_RUNTIME_CPUDetect 0
            echo #define CONFIG_SAFE_BITSTREAM_READER 1
            echo #define CONFIG_ICONV 0
            echo #define CONFIG_RDFT 0
            echo #define CONFIG_DCT 0
            echo #define CONFIG_VIDSTAB 0
            echo #define CONFIG_DEINTERLACE 0
            echo #define CONFIG_FREI0R 0
            echo #define CONFIG_LIBVIDSTAB 0
            if "${{ github.event.inputs.build_x264 }}" == "true" (
                echo #define CONFIG_LIBX264 1
                echo #define CONFIG_GPL 1
            ) else (
                echo #define CONFIG_LIBX264 0
                echo #define CONFIG_GPL 0
            )
            echo #define CONFIG_SMALL 0
            echo #endif
        ) > ffbuild\config.h
        
        :: 创建完整的MSVC构建配置
        echo 创建完整的MSVC构建配置...
        (
            echo # FFmpeg MSVC Configuration - Direct Build
            echo PREFIX=%FFMPEG_INSTALL%
            echo CC=cl
            echo CXX=cl
            echo LD=link
            echo AR=lib
            echo NM=nm
            echo STRIP=strip
            echo OBJCOPY=objcopy
            echo OBJDUMP=objdump
            echo LN=ln
            echo AS=ml64
            echo CPPFLAGS=
            echo CFLAGS=-MD -D_ISOC99_SOURCE -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -D_USE_MATH_DEFINES -D_CRT_SECURE_NO_WARNINGS -D_CRT_NONSTDC_NO_WARNINGS -D_WIN32_WINNT=0x0600 -nologo -O2
            echo CXXFLAGS=
            echo ASFLAGS=
            echo LDFLAGS=-nologo -DLL
            echo SHFLAGS=-DLL
            echo YASMFLAGS=
            echo X86ASMFLAGS=
            echo DEPFLAGS=
            echo CMD_O=-Fo
            echo CMD_OO=-Fo
            echo CMD_C=-c
            echo CMD_E=
            echo CMD_EO=
            echo LIBPREF=
            echo LIBSUF=.lib
            echo LIBNAME=
            echo SLIBPREF=
            echo SLIBSUF=.dll
            echo EXESUF=.exe
            echo LIB_INSTALL=%FFMPEG_INSTALL%\lib
            echo BIN_INSTALL=%FFMPEG_INSTALL%\bin
            echo INC_INSTALL=%FFMPEG_INSTALL%\include
            echo DATA_INSTALL=%FFMPEG_INSTALL%\share
            echo SHLIB_INSTALL=%FFMPEG_INSTALL%\bin
            echo DOC_INSTALL=%FFMPEG_INSTALL%\share\doc
            echo PROGS_INSTALL=%FFMPEG_INSTALL%\bin
            echo MAN_INSTALL=%FFMPEG_INSTALL%\share\man
            echo LOCALIDDIR=
            echo PKGCONFIGDIR=%FFMPEG_INSTALL%\lib\pkgconfig
            echo CONFIG_MAKEFILE=ffbuild\config.mak
            echo CONFIG_H=ffbuild\config.h
            echo ARCH=X86_64
            echo SUBARCH=x86_64
            echo TARGET_OS=WIN32
            echo TOOLCHAIN=MSVC
            echo SYSARCH=
            echo SUFFIX=
            echo HAVE_64BIT=yes
            echo HAVE_BIGENDIAN=no
            echo HAVE_FAST_UNALIGNED=no
            echo HAVE_FAST_CLZ=no
            echo HAVE_FAST_64BIT=no
            echo HAVE_INLINE_ASM=no
            echo HAVE_SYMVER=no
            echo HAVE_X86ASM=no
            echo HAVE_ALIGNED_STACK=no
            echo HAVE_EBP_AVAILABLE=no
            echo HAVE_FAST_CMOV=no
            echo HAVE_LOCAL_ALIGNED=no
            echo HAVE_MMX=no
            echo HAVE_SSE=no
            echo HAVE_SSE2=no
            echo HAVE_SSE3=no
            echo HAVE_SSSE3=no
            echo HAVE_SSE4=no
            echo HAVE_SSE42=no
            echo HAVE_AVX=no
            echo HAVE_AVX2=no
            echo HAVE_AVX512=no
            echo HAVE_ALTIVEC=no
            echo HAVE_VSX=no
            echo HAVE_POWER8=no
            echo HAVE_ARMV5TE=no
            echo HAVE_ARMV6=no
            echo HAVE_ARMV6T2=no
            echo HAVE_VFP=no
            echo HAVE_NEON=no
            echo HAVE_ARMV8=no
            echo HAVE_MIPS=no
            echo HAVE_MMI=no
            echo HAVE_MSA=no
            echo HAVE_MSA2=no
            echo HAVE_LOONGSON=no
            echo HAVE_RV=no
            echo HAVE_RVV=no
            echo HAVE_RISCV_VECTOR=no
            echo HAVE_RISCV_ZVE32X=no
            echo HAVE_RISCV_ZVE64D=no
            echo HAVE_RISCV_ZVL128B=no
            echo HAVE_RISCV_ZVL256B=no
            echo HAVE_RISCV_ZVL512B=no
            echo HAVE_RISCV_ZVL1024B=no
            echo HAVE_RISCV_ZVL2048B=no
            echo HAVE_RISCV_ZVL4096B=no
            echo HAVE_RISCV_ZVL8192B=no
            echo HAVE_RISCV_ZVL16384B=no
            echo HAVE_RISCV_ZVL32768B=no
            echo HAVE_RISCV_ZVL65536B=no
            echo HAVE_RISCV_ZVL131072B=no
            echo HAVE_RISCV_ZVL262144B=no
            echo HAVE_RISCV_ZVL524288B=no
            echo HAVE_RISCV_ZVL1048576B=no
            echo HAVE_RISCV_ZVL2097152B=no
            echo HAVE_RISCV_ZVL4194304B=no
            echo HAVE_RISCV_ZVL8388608B=no
            echo HAVE_RISCV_ZVL16777216B=no
            echo HAVE_RISCV_ZVL33554432B=no
            echo HAVE_RISCV_ZVL67108864B=no
            echo HAVE_RISCV_ZVL134217728B=no
            echo HAVE_RISCV_ZVL268435456B=no
            echo HAVE_RISCV_ZVL536870912B=no
            echo HAVE_RISCV_ZVL1073741824B=no
            echo # 功能配置
            echo CONFIG_SHARED=yes
            echo CONFIG_STATIC=no
            echo CONFIG_SMALL=no
            echo CONFIG_RUNTIME_CPUDetect=no
            echo CONFIG_SAFE_BITSTREAM_READER=yes
            echo CONFIG_ICONV=no
            echo CONFIG_RDFT=no
            echo CONFIG_DCT=no
            echo CONFIG_VIDSTAB=no
            echo CONFIG_DEINTERLACE=no
            echo CONFIG_FREI0R=no
            echo CONFIG_LIBVIDSTAB=no
            if "${{ github.event.inputs.build_x264 }}" == "true" (
                echo CONFIG_LIBX264=yes
            ) else (
                echo CONFIG_LIBX264=no
            )
            echo CONFIG_AVCODEC=yes
            echo CONFIG_AVFORMAT=yes
            echo CONFIG_AVUTIL=yes
            echo CONFIG_SWSCALE=yes
            echo CONFIG_SWRESAMPLE=yes
            echo CONFIG_AVFILTER=yes
            echo CONFIG_POSTPROC=no
            echo CONFIG_AVDEVICE=yes
            echo CONFIG_FFMPEG=no
            echo CONFIG_FFPLAY=no
            echo CONFIG_FFPROBE=no
            echo CONFIG_DOC=no
            echo CONFIG_H264_DECODER=yes
            echo CONFIG_H264_PARSER=yes
            echo CONFIG_MOV_DEMUXER=yes
            echo CONFIG_MP4_DEMUXER=yes
            echo CONFIG_MATROSKA_DEMUXER=yes
            echo CONFIG_AVI_DEMUXER=yes
            echo CONFIG_FLV_DEMUXER=yes
            echo CONFIG_MPEGTS_DEMUXER=yes
            echo CONFIG_FILE_PROTOCOL=yes
            echo CONFIG_HTTP_PROTOCOL=no
            echo CONFIG_HTTPS_PROTOCOL=no
            echo CONFIG_TCP_PROTOCOL=no
            echo CONFIG_UDP_PROTOCOL=no
        ) > ffbuild\config.mak
        
        echo 跳过configure，直接使用预定义配置编译FFmpeg...
        
        :: 检查配置是否成功
        if not exist ffbuild\config.mak (
          echo ERROR: Configure failed - config.mak not found
          dir ffbuild
          exit 1
        )
        
        :: 显示配置文件内容前几行
        echo 显示config.mak前20行:
        powershell -Command "Get-Content ffbuild\config.mak | Select-Object -First 20"
        
        :: 编译FFmpeg
        echo 正在编译FFmpeg...
        nmake || (
          echo 编译失败，查看详细错误信息:
          if exist ffbuild\config.log (
            powershell -Command "Get-Content ffbuild\config.log | Select-Object -Last 50"
          )
          exit 1
        )
        
        :: 安装FFmpeg
        echo 正在安装FFmpeg...
        nmake install
        
    # ========== 产物打包/上传/发布 ==========
    
    # 构建产物打包
    - name: Package Build Artifacts
      shell: cmd
      run: |
        :: 创建输出目录结构
        mkdir %WORKSPACE%\ffmpeg-build-output\bin 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\lib 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\include 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\licenses 2>nul || true
        
        :: 复制FFmpeg MSVC产物
        copy /Y %FFMPEG_INSTALL%\bin\*.dll %WORKSPACE%\ffmpeg-build-output\bin\
        copy /Y %FFMPEG_INSTALL%\lib\*.lib %WORKSPACE%\ffmpeg-build-output\lib\
        xcopy /E /Y %FFMPEG_INSTALL%\include\* %WORKSPACE%\ffmpeg-build-output\include\
        
        :: 复制x264产物（仅在启用时）
        if "${{ github.event.inputs.build_x264 }}" == "true" (
          copy /Y %X264_INSTALL%\bin\*.dll %WORKSPACE%\ffmpeg-build-output\bin\ 2>nul || echo x264 DLL not found, skipping
          copy /Y %X264_INSTALL%\lib\*.lib %WORKSPACE%\ffmpeg-build-output\lib\ 2>nul || echo x264 LIB not found, skipping
        )
        
        :: 复制许可证文件
        copy /Y %WORKSPACE%\ffmpeg\LICENSE.md %WORKSPACE%\ffmpeg-build-output\licenses\FFmpeg.txt 2>nul || true
        if "${{ github.event.inputs.build_x264 }}" == "true" (
          copy /Y %WORKSPACE%\x264\COPYING %WORKSPACE%\ffmpeg-build-output\licenses\x264.txt 2>nul || true
        )
        
        :: 验证MSVC产物
        echo 编译产物:
        dir %WORKSPACE%\ffmpeg-build-output\bin
        dir %WORKSPACE%\ffmpeg-build-output\lib

    # 上传构建产物到GitHub Artifacts
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows-x64-shared-n${{ env.FFMPEG_VERSION }}
        path: ${{ env.WORKSPACE }}\ffmpeg-build-output\
        retention-days: 90

    # 打包为ZIP文件
    - name: Package as ZIP
      shell: powershell
      run: |
        Compress-Archive -Path ${{ env.WORKSPACE }}\ffmpeg-build-output\* -DestinationPath ${{ env.WORKSPACE }}\ffmpeg-windows-x64-shared-n${{ env.FFMPEG_VERSION }}.zip -Force

    # 创建GitHub Release
    - name: Create Release
      id: create_release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: n${{ env.FFMPEG_VERSION }}-${{ github.run_number }}
        name: FFmpeg Windows Build v${{ env.FFMPEG_VERSION }}-${{ github.run_number }}
        draft: false
        prerelease: false
        files: ${{ env.WORKSPACE }}\ffmpeg-windows-x64-shared-n${{ env.FFMPEG_VERSION }}.zip
        body: |
          FFmpeg ${{ env.FFMPEG_VERSION }} Windows build with:
          - MSVC 2022 (v14.38) toolchain (x64)
          - Shared libraries (DLL + MSVC import LIB)
          - Headers for development
          - x264 support: ${{ github.event.inputs.build_x264 == 'true' && 'enabled' || 'disabled' }}
          
          ## Files included:
          - Binaries (MSVC-compiled DLLs)
          - MSVC import libraries (.lib)
          - Header files
          - Licenses
          
          ## Version Info
          - Build Number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
