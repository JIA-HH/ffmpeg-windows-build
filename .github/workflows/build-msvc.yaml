name: FFmpeg with MSVC

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release after build'
        required: false
        default: 'true'
        type: boolean
      build_x264:
        description: 'Build x264 support (default: false)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  actions: read

env:
  FFMPEG_VERSION: 5.1.4
  WORKSPACE: ${{ github.workspace }}
  X264_INSTALL: ${{ github.workspace }}\x264-install
  FFMPEG_INSTALL: ${{ github.workspace }}\ffmpeg-install
  # 缓存哈希基准文件（修改脚本时缓存自动更新）
  CACHE_HASH_FILE: ${{ github.workspace }}/.github/workflows/ffmpeg-msvc.yml

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # ========== 环境设置 ==========
    
    # MSYS2 缓存和辅助工具设置
    - name: Cache MSYS2 Dependencies
      id: cache-msys2
      uses: actions/cache@v4
      with:
        path: ${{ runner.temp }}/msys64
        key: msys2-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          msys2-${{ runner.os }}-
          
    - name: Setup MSYS2 (仅辅助工具，无MinGW编译依赖)
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: ${{ steps.cache-msys2.outputs.cache-hit != 'true' }}
        install: >-
          git
          make
          wget
          unzip
          sed
          pkg-config
          mingw-w64-x86_64-yasm
          flex
          bison

    # MSVC 环境设置
    - name: Setup Visual Studio Environment (纯MSVC核心环境)
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        vsversion: 2022
        spectre: false

    # MSVC 编译依赖缓存和安装
    - name: Cache MSVC编译依赖
      id: cache-msvc-deps
      uses: actions/cache@v4
      with:
        path: |
          C:\Program Files\NASM
          C:\Program Files\CMake
        key: msvc-deps-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          msvc-deps-${{ runner.os }}-
          
    - name: Install MSVC编译依赖
      if: steps.cache-msvc-deps.outputs.cache-hit != 'true'
      run: |
        choco install nasm -y --no-progress
        choco install cmake -y --no-progress --install-arguments 'ADD_CMAKE_TO_PATH=System'
        refreshenv  # 刷新环境变量，确保nasm/cmake可用
        
    # ========== x264 纯MSVC编译 (可选) ==========
    
    # x264 源码缓存
    - name: Cache x264 Source
      id: cache-x264-source
      if: github.event.inputs.build_x264 == 'true'
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKSPACE }}\x264
        key: x264-source-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          x264-source-${{ runner.os }}-

    # x264 源码下载
    - name: Clone x264 Source
      if: steps.cache-x264-source.outputs.cache-hit != 'true' && github.event.inputs.build_x264 == 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%
        rmdir /s /q x264 2>nul || true
        git clone --depth=1 https://code.videolan.org/videolan/x264.git x264
        cd x264 && git rev-parse --short HEAD && cd ..

    # x264 编译产物缓存
    - name: Cache x264 Build
      id: cache-x264-build
      if: github.event.inputs.build_x264 == 'true'
      uses: actions/cache@v4
      with:
        path: ${{ env.X264_INSTALL }}
        key: x264-build-msvc-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          x264-build-msvc-${{ runner.os }}-

    # x264 编译构建
    - name: Build x264 with MSVC
      if: steps.cache-x264-build.outputs.cache-hit != 'true' && github.event.inputs.build_x264 == 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%\x264
        
        :: 清理之前的配置
        del config.mak 2>nul || true
        
        :: 使用MSVC编译x264
        bash -c "./configure --prefix='%X264_INSTALL%' --enable-shared --enable-win32thread --disable-cli --toolchain=msvc"
        
        :: 编译和安装
        make -j%NUMBER_OF_PROCESSORS%
        make install
        
    # ========== FFmpeg 纯MSVC编译 ==========
    
    # FFmpeg 源码缓存
    - name: Cache FFmpeg Source
      id: cache-ffmpeg-source
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKSPACE }}\ffmpeg
        key: ffmpeg-source-n${{ env.FFMPEG_VERSION }}-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          ffmpeg-source-n${{ env.FFMPEG_VERSION }}-${{ runner.os }}-

    # FFmpeg 源码下载
    - name: Clone FFmpeg Source 
      if: steps.cache-ffmpeg-source.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%
        rmdir /s /q ffmpeg 2>nul || true
        git clone --depth=1 --branch=n%FFMPEG_VERSION% https://github.com/FFmpeg/FFmpeg.git ffmpeg
        cd ffmpeg && git rev-parse --short HEAD && cd ..

    # FFmpeg 数学函数兼容性修复
    - name: Patch FFmpeg libm.h
      shell: msys2 {0}
      run: |
        cd $WORKSPACE/ffmpeg/libavutil
        cp libm.h libm.h.bak
        sed -i 's/#if !HAVE_/#if 0 \/\/ disabled for MSVC - #if !HAVE_/g' libm.h
        sed -i 's/#elif !HAVE_/#elif 0 \/\/ disabled for MSVC - #elif !HAVE_/g' libm.h
        cat libm.h | grep -E "#if 0.*HAVE_" | head -5

    # FFmpeg 编译产物缓存
    - name: Cache FFmpeg Build
      id: cache-ffmpeg-build
      uses: actions/cache@v4
      with:
        path: ${{ env.FFMPEG_INSTALL }}
        key: ffmpeg-build-n${{ env.FFMPEG_VERSION }}-msvc-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          ffmpeg-build-n${{ env.FFMPEG_VERSION }}-msvc-${{ runner.os }}-

    # FFmpeg 核心编译
    - name: Build FFmpeg with MSVC (纯MSVC工具链)
      if: steps.cache-ffmpeg-build.outputs.cache-hit != 'true'
      shell: powershell
      run: |
        cd $env:WORKSPACE\ffmpeg
        
        # 清理之前的配置
        Remove-Item -Path "ffbuild\config.mak" -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "ffbuild\config.h" -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "config.log" -Force -ErrorAction SilentlyContinue
        
        Write-Host "验证编译器环境:"
        Get-Command cl -ErrorAction SilentlyContinue
        if (Get-Command cl -ErrorAction SilentlyContinue) {
            Write-Host "MSVC编译器已正确设置"
        } else {
            Write-Host "ERROR: MSVC编译器未找到"
            exit 1
        }
        
        # 显示关键环境变量
        Write-Host "PATH=$env:PATH"
        Write-Host "INCLUDE=$env:INCLUDE"
        Write-Host "LIB=$env:LIB"
        
        # 创建config.h文件
        Write-Host "创建config.h文件..."
        $configH = @"
/* FFmpeg MSVC Configuration Header */
#ifndef FFMPEG_CONFIG_H
#define FFMPEG_CONFIG_H
#define FFMPEG_CONFIGURATION ""
#define FFMPEG_LICENSE "LGPL version 2.1 or later"
#define THIS_YEAR 2024
#define CC_IDENT "msvc"
#define OS_NAME win32
#define HAVE_AV_CONFIG_H 1
#define ARCH_X86_64 1
#define HAVE_INLINE_ASM 0
#define HAVE_SYMVER 0
#define HAVE_X86ASM 0
#define restrict __restrict
#define inline __inline
#define CONFIG_SHARED 1
#define CONFIG_STATIC 0
#define CONFIG_AVUTIL 1
#define CONFIG_AVCODEC 1
#define CONFIG_AVFORMAT 1
#define CONFIG_SWSCALE 1
#define CONFIG_SWRESAMPLE 1
#define CONFIG_AVFILTER 1
#define CONFIG_AVDEVICE 1
#define CONFIG_POSTPROC 0
#define CONFIG_FFMPEG 0
#define CONFIG_FFPLAY 0
#define CONFIG_FFPROBE 0
#define CONFIG_DOC 0
#define CONFIG_H264_DECODER 1
#define CONFIG_H264_PARSER 1
#define CONFIG_MOV_DEMUXER 1
#define CONFIG_MP4_DEMUXER 1
#define CONFIG_MATROSKA_DEMUXER 1
#define CONFIG_AVI_DEMUXER 1
#define CONFIG_FLV_DEMUXER 1
#define CONFIG_MPEGTS_DEMUXER 1
#define CONFIG_FILE_PROTOCOL 1
#define CONFIG_HTTP_PROTOCOL 0
#define CONFIG_HTTPS_PROTOCOL 0
#define CONFIG_TCP_PROTOCOL 0
#define CONFIG_UDP_PROTOCOL 0
#define CONFIG_RUNTIME_CPUDetect 0
#define CONFIG_SAFE_BITSTREAM_READER 1
#define CONFIG_ICONV 0
#define CONFIG_RDFT 0
#define CONFIG_DCT 0
#define CONFIG_VIDSTAB 0
#define CONFIG_DEINTERLACE 0
#define CONFIG_FREI0R 0
#define CONFIG_LIBVIDSTAB 0
#define CONFIG_LIBX264 ${{ github.event.inputs.build_x264 == 'true' && '1' || '0' }}
#define CONFIG_SMALL 0
#define CONFIG_GPL ${{ github.event.inputs.build_x264 == 'true' && '1' || '0' }}
#endif
"@
        $configH | Out-File -FilePath "ffbuild\config.h" -Encoding UTF8
        
        # 创建完整的MSVC构建配置
        Write-Host "创建完整的MSVC构建配置..."
        $configMak = @"
# FFmpeg MSVC Configuration - Direct Build
PREFIX=$env:FFMPEG_INSTALL
CC=cl
CXX=cl
LD=link
AR=lib
NM=nm
STRIP=strip
OBJCOPY=objcopy
OBJDUMP=objdump
LN=ln
AS=ml64
CPPFLAGS=
CFLAGS=-MD -D_ISOC99_SOURCE -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -D_USE_MATH_DEFINES -D_CRT_SECURE_NO_WARNINGS -D_CRT_NONSTDC_NO_WARNINGS -D_WIN32_WINNT=0x0600 -nologo -O2
CXXFLAGS=
ASFLAGS=
LDFLAGS=-nologo -DLL
SHFLAGS=-DLL
YASMFLAGS=
X86ASMFLAGS=
DEPFLAGS=
CMD_O=-Fo
CMD_OO=-Fo
CMD_C=-c
CMD_E=
CMD_EO=
LIBPREF=
LIBSUF=.lib
LIBNAME=
SLIBPREF=
SLIBSUF=.dll
EXESUF=.exe
LIB_INSTALL=$env:FFMPEG_INSTALL/lib
BIN_INSTALL=$env:FFMPEG_INSTALL/bin
INC_INSTALL=$env:FFMPEG_INSTALL/include
DATA_INSTALL=$env:FFMPEG_INSTALL/share
SHLIB_INSTALL=$env:FFMPEG_INSTALL/bin
DOC_INSTALL=$env:FFMPEG_INSTALL/share/doc
PROGS_INSTALL=$env:FFMPEG_INSTALL/bin
MAN_INSTALL=$env:FFMPEG_INSTALL/share/man
LOCALIDDIR=
PKGCONFIGDIR=$env:FFMPEG_INSTALL/lib/pkgconfig
CONFIG_MAKEFILE=ffbuild/config.mak
CONFIG_H=ffbuild/config.h
ARCH=X86_64
SUBARCH=x86_64
TARGET_OS=WIN32
TOOLCHAIN=MSVC
SYSARCH=
SUFFIX=
HAVE_64BIT=yes
HAVE_BIGENDIAN=no
HAVE_FAST_UNALIGNED=no
HAVE_FAST_CLZ=no
HAVE_FAST_64BIT=no
HAVE_INLINE_ASM=no
HAVE_SYMVER=no
HAVE_X86ASM=no
HAVE_ALIGNED_STACK=no
HAVE_EBP_AVAILABLE=no
HAVE_FAST_CMOV=no
HAVE_LOCAL_ALIGNED=no
HAVE_MMX=no
HAVE_SSE=no
HAVE_SSE2=no
HAVE_SSE3=no
HAVE_SSSE3=no
HAVE_SSE4=no
HAVE_SSE42=no
HAVE_AVX=no
HAVE_AVX2=no
HAVE_AVX512=no
HAVE_ALTIVEC=no
HAVE_VSX=no
HAVE_POWER8=no
HAVE_ARMV5TE=no
HAVE_ARMV6=no
HAVE_ARMV6T2=no
HAVE_VFP=no
HAVE_NEON=no
HAVE_ARMV8=no
HAVE_MIPS=no
HAVE_MMI=no
HAVE_MSA=no
HAVE_MSA2=no
HAVE_LOONGSON=no
HAVE_RV=no
HAVE_RVV=no
HAVE_RISCV_VECTOR=no
HAVE_RISCV_ZVE32X=no
HAVE_RISCV_ZVE64D=no
HAVE_RISCV_ZVL128B=no
HAVE_RISCV_ZVL256B=no
HAVE_RISCV_ZVL512B=no
HAVE_RISCV_ZVL1024B=no
HAVE_RISCV_ZVL2048B=no
HAVE_RISCV_ZVL4096B=no
HAVE_RISCV_ZVL8192B=no
HAVE_RISCV_ZVL16384B=no
HAVE_RISCV_ZVL32768B=no
HAVE_RISCV_ZVL65536B=no
HAVE_RISCV_ZVL131072B=no
HAVE_RISCV_ZVL262144B=no
HAVE_RISCV_ZVL524288B=no
HAVE_RISCV_ZVL1048576B=no
HAVE_RISCV_ZVL2097152B=no
HAVE_RISCV_ZVL4194304B=no
HAVE_RISCV_ZVL8388608B=no
HAVE_RISCV_ZVL16777216B=no
HAVE_RISCV_ZVL33554432B=no
HAVE_RISCV_ZVL67108864B=no
HAVE_RISCV_ZVL134217728B=no
HAVE_RISCV_ZVL268435456B=no
HAVE_RISCV_ZVL536870912B=no
HAVE_RISCV_ZVL1073741824B=no
# 功能配置
CONFIG_SHARED=yes
CONFIG_STATIC=no
CONFIG_SMALL=no
CONFIG_RUNTIME_CPUDetect=no
CONFIG_SAFE_BITSTREAM_READER=yes
CONFIG_ICONV=no
CONFIG_RDFT=no
CONFIG_DCT=no
CONFIG_VIDSTAB=no
CONFIG_DEINTERLACE=no
CONFIG_FREI0R=no
CONFIG_LIBVIDSTAB=no
CONFIG_LIBX264=${{ github.event.inputs.build_x264 == 'true' && 'yes' || 'no' }}
CONFIG_AVCODEC=yes
CONFIG_AVFORMAT=yes
CONFIG_AVUTIL=yes
CONFIG_SWSCALE=yes
CONFIG_SWRESAMPLE=yes
CONFIG_AVFILTER=yes
CONFIG_POSTPROC=no
CONFIG_AVDEVICE=yes
CONFIG_FFMPEG=no
CONFIG_FFPLAY=no
CONFIG_FFPROBE=no
CONFIG_DOC=no
CONFIG_H264_DECODER=yes
CONFIG_H264_PARSER=yes
CONFIG_MOV_DEMUXER=yes
CONFIG_MP4_DEMUXER=yes
CONFIG_MATROSKA_DEMUXER=yes
CONFIG_AVI_DEMUXER=yes
CONFIG_FLV_DEMUXER=yes
CONFIG_MPEGTS_DEMUXER=yes
CONFIG_FILE_PROTOCOL=yes
CONFIG_HTTP_PROTOCOL=no
CONFIG_HTTPS_PROTOCOL=no
CONFIG_TCP_PROTOCOL=no
CONFIG_UDP_PROTOCOL=no
"@
        $configMak | Out-File -FilePath "ffbuild\config.mak" -Encoding UTF8
        
        Write-Host "跳过configure，直接使用预定义配置编译FFmpeg..."
        
        # 检查配置是否成功
        if (-not (Test-Path "ffbuild\config.mak")) {
            Write-Host "ERROR: Configure failed - config.mak not found"
            Get-ChildItem -Path "ffbuild" -ErrorAction SilentlyContinue
            exit 1
        }
        
        # 显示配置文件内容
        Write-Host "显示config.mak完整内容:"
        Get-Content "ffbuild\config.mak"
        
        # 编译FFmpeg
        Write-Host "正在编译FFmpeg..."
        nmake
        if ($LASTEXITCODE -ne 0) {
            Write-Host "编译失败，退出码: $LASTEXITCODE"
            if (Test-Path "ffbuild\config.log") {
                Write-Host "配置日志最后50行:"
                Get-Content "ffbuild\config.log" | Select-Object -Last 50
            }
            exit 1
        }
        
        # 安装FFmpeg
        Write-Host "正在安装FFmpeg..."
        nmake install
        if ($LASTEXITCODE -ne 0) {
            Write-Host "安装失败，退出码: $LASTEXITCODE"
            exit 1
        }
        
    # ========== 产物打包/上传/发布 ==========
    
    # 构建产物打包
    - name: Package Build Artifacts
      shell: cmd
      run: |
        :: 创建输出目录结构
        mkdir %WORKSPACE%\ffmpeg-build-output\bin 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\lib 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\include 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\licenses 2>nul || true
        
        :: 复制FFmpeg MSVC产物
        copy /Y %FFMPEG_INSTALL%\bin\*.dll %WORKSPACE%\ffmpeg-build-output\bin\
        copy /Y %FFMPEG_INSTALL%\lib\*.lib %WORKSPACE%\ffmpeg-build-output\lib\
        xcopy /E /Y %FFMPEG_INSTALL%\include\* %WORKSPACE%\ffmpeg-build-output\include\
        
        :: 复制x264产物（仅在启用时）
        if "${{ github.event.inputs.build_x264 }}" == "true" (
          copy /Y %X264_INSTALL%\bin\*.dll %WORKSPACE%\ffmpeg-build-output\bin\ 2>nul || echo x264 DLL not found, skipping
          copy /Y %X264_INSTALL%\lib\*.lib %WORKSPACE%\ffmpeg-build-output\lib\ 2>nul || echo x264 LIB not found, skipping
        )
        
        :: 复制许可证文件
        copy /Y %WORKSPACE%\ffmpeg\LICENSE.md %WORKSPACE%\ffmpeg-build-output\licenses\FFmpeg.txt 2>nul || true
        if "${{ github.event.inputs.build_x264 }}" == "true" (
          copy /Y %WORKSPACE%\x264\COPYING %WORKSPACE%\ffmpeg-build-output\licenses\x264.txt 2>nul || true
        )
        
        :: 验证MSVC产物
        echo 编译产物:
        dir %WORKSPACE%\ffmpeg-build-output\bin
        dir %WORKSPACE%\ffmpeg-build-output\lib

    # 上传构建产物到GitHub Artifacts
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows-x64-shared-n${{ env.FFMPEG_VERSION }}
        path: ${{ env.WORKSPACE }}\ffmpeg-build-output\
        retention-days: 90

    # 打包为ZIP文件
    - name: Package as ZIP
      shell: powershell
      run: |
        Compress-Archive -Path ${{ env.WORKSPACE }}\ffmpeg-build-output\* -DestinationPath ${{ env.WORKSPACE }}\ffmpeg-windows-x64-shared-n${{ env.FFMPEG_VERSION }}.zip -Force

    # 创建GitHub Release
    - name: Create Release
      id: create_release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: n${{ env.FFMPEG_VERSION }}-${{ github.run_number }}
        name: FFmpeg Windows Build v${{ env.FFMPEG_VERSION }}-${{ github.run_number }}
        draft: false
        prerelease: false
        files: ${{ env.WORKSPACE }}\ffmpeg-windows-x64-shared-n${{ env.FFMPEG_VERSION }}.zip
        body: |
          FFmpeg ${{ env.FFMPEG_VERSION }} Windows build with:
          - MSVC 2022 (v14.38) toolchain (x64)
          - Shared libraries (DLL + MSVC import LIB)
          - Headers for development
          - x264 support: ${{ github.event.inputs.build_x264 == 'true' && 'enabled' || 'disabled' }}
          
          ## Files included:
          - Binaries (MSVC-compiled DLLs)
          - MSVC import libraries (.lib)
          - Header files
          - Licenses
          
          ## Version Info
          - Build Number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
