name: FFmpeg with MSVC

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release after build'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  actions: read

env:
  FFPEG_VERSION: 5.1.4
  WORKSPACE: ${{ github.workspace }}
  X264_INSTALL: ${{ github.workspace }}\x264-install
  FFMPEG_INSTALL: ${{ github.workspace }}\ffmpeg-install
  # 缓存哈希基准文件（修改脚本时缓存自动更新）
  CACHE_HASH_FILE: ${{ github.workspace }}/.github/workflows/ffmpeg-msvc.yml

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    # 修复1：MSYS2缓存路径（匹配setup-msys2默认路径）+ 仅安装辅助工具
    - name: Cache MSYS2 Dependencies
      id: cache-msys2
      uses: actions/cache@v4
      with:
        path: ${{ runner.temp }}/msys64
        key: msys2-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          msys2-${{ runner.os }}-
          
    - name: Setup MSYS2 (仅辅助工具，无MinGW编译依赖)
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: ${{ steps.cache-msys2.outputs.cache-hit != 'true' }}
        install: >-
          git
          make
          wget
          unzip
          sed
          pkg-config
          mingw-w64-x86_64-yasm
          flex
          bison
      
    # 修复2：MSVC环境明确初始化（指定版本+工具集）
    - name: Setup Visual Studio Environment (纯MSVC核心环境)
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        vsversion: 2022
        # toolset: latest  # 明确VS2022工具集版本，避免"latest"找不到目录
        spectre: false
        
    # 修复3：MSVC编译依赖缓存（nasm/cmake）
    - name: Cache MSVC编译依赖
      id: cache-msvc-deps
      uses: actions/cache@v4
      with:
        path: |
          C:\Program Files\NASM
          C:\Program Files\CMake
        key: msvc-deps-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          msvc-deps-${{ runner.os }}-
          
    - name: Install MSVC编译依赖
      if: steps.cache-msvc-deps.outputs.cache-hit != 'true'
      run: |
        choco install nasm -y --no-progress
        choco install cmake -y --no-progress --install-arguments 'ADD_CMAKE_TO_PATH=System'
        refreshenv  # 刷新环境变量，确保nasm/cmake可用
        
    # ========== x264 纯MSVC编译 ==========
    - name: Cache x264 Source
      id: cache-x264-source
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKSPACE }}\x264
        key: x264-source-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          x264-source-${{ runner.os }}-
          
    - name: Clone x264 Source
      if: steps.cache-x264-source.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%
        rmdir /s /q x264 2>nul || true
        git clone --depth=1 https://code.videolan.org/videolan/x264.git x264
        cd x264 && git rev-parse --short HEAD && cd ..
        
    - name: Cache x264 Build
      id: cache-x264-build
      uses: actions/cache@v4
      with:
        path: ${{ env.X264_INSTALL }}
        key: x264-build-msvc-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          x264-build-msvc-${{ runner.os }}-
          
    # 暂时跳过x264编译（先解决FFmpeg本身的MSVC编译问题）
    - name: Skip x264 Build (临时禁用)
      shell: cmd
      run: |
        echo 暂时跳过x264编译，专注于FFmpeg本身的MSVC编译问题
        
    # ========== FFmpeg 纯MSVC编译 ==========
    - name: Cache FFmpeg Source
      id: cache-ffmpeg-source
      uses: actions/cache@v4
      with:
        path: ${{ env.WORKSPACE }}\ffmpeg
        key: ffmpeg-source-n${{ env.FFPEG_VERSION }}-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          ffmpeg-source-n${{ env.FFPEG_VERSION }}-${{ runner.os }}-
          
    - name: Clone FFmpeg Source 
      if: steps.cache-ffmpeg-source.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%
        rmdir /s /q ffmpeg 2>nul || true
        git clone --depth=1 --branch=n%FFPEG_VERSION% https://github.com/FFmpeg/FFmpeg.git ffmpeg
        cd ffmpeg && git rev-parse --short HEAD && cd ..
        
    # 保留：修复libm.h数学函数定义（MSVC兼容）
    - name: Patch FFmpeg libm.h
      shell: msys2 {0}
      run: |
        cd $WORKSPACE/ffmpeg/libavutil
        cp libm.h libm.h.bak
        sed -i 's/#if !HAVE_/#if 0 \/\/ disabled for MSVC - #if !HAVE_/g' libm.h
        sed -i 's/#elif !HAVE_/#elif 0 \/\/ disabled for MSVC - #elif !HAVE_/g' libm.h
        cat libm.h | grep -E "#if 0.*HAVE_" | head -5
        
    - name: Cache FFmpeg Build
      id: cache-ffmpeg-build
      uses: actions/cache@v4
      with:
        path: ${{ env.FFMPEG_INSTALL }}
        key: ffmpeg-build-n${{ env.FFPEG_VERSION }}-msvc-${{ runner.os }}-${{ hashFiles(env.CACHE_HASH_FILE) }}
        restore-keys: |
          ffmpeg-build-n${{ env.FFPEG_VERSION }}-msvc-${{ runner.os }}-
          
    # 核心修复：FFmpeg纯MSVC编译（cl.exe/link.exe）
    - name: Build FFmpeg with MSVC (纯MSVC工具链)
      if: steps.cache-ffmpeg-build.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        cd %WORKSPACE%\ffmpeg
        del ffbuild\config.mak 2>nul || true
        
        :: 纯MSVC环境变量（指定cl/link/lib等MSVC工具）
        set CC=cl
        set CXX=cl
        set LD=link
        set AR=lib
        set RANLIB=echo
        set STRIP=echo
        
        :: 暂时不使用x264，先解决FFmpeg本身的MSVC编译问题
        echo 暂时不使用x264，专注于FFmpeg本身的MSVC编译问题
        
        :: 手动刷新MSVC环境（确保工具链生效）
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
        
        :: 验证编译器环境
        echo 验证编译器环境:
        where cl
        cl 2>&1 | findstr /C:"Microsoft" >nul && echo MSVC编译器已正确设置 || echo MSVC编译器设置失败
        
        :: 显示当前环境变量
        echo PATH=%PATH%
        echo INCLUDE=%INCLUDE%
        echo LIB=%LIB%
        
        :: FFmpeg Configure（纯MSVC参数，无MinGW/cross-compile，暂时不使用x264）
        :: 使用bash来执行configure脚本，但在MSVC环境中
        bash -c "./configure --prefix='%FFMPEG_INSTALL%' --target-os=win32 --arch=x86_64 --toolchain=msvc --enable-shared --disable-static --disable-programs --disable-doc --disable-asm --extra-cflags='-MD -DHAVE_LRINT=1 -DHAVE_LRINTF=1 -DHAVE_RINT=1 -DHAVE_ROUND=1 -DHAVE_TRUNC=1 -DHAVE_CBRT=1 -DHAVE_ERF=1' --disable-examples"
        
        :: 检查配置是否成功
        if not exist ffbuild\config.mak (
          echo ERROR: Configure failed - config.mak not found
          dir ffbuild
          echo "显示配置日志的最后50行以帮助诊断问题:"
          powershell -Command "Get-Content ffbuild\config.log | Select-Object -Last 50"
          exit 1
        )
        
        :: MSVC编译+安装（避免示例文件导致的awk错误）
        make -j %NUMBER_OF_PROCESSORS% || (
          echo 标准编译失败，尝试禁用问题组件后重新编译...
          make clean
          bash -c "./configure --prefix='%FFMPEG_INSTALL%' --target-os=win32 --arch=x86_64 --toolchain=msvc --enable-shared --disable-static --disable-programs --disable-doc --disable-asm --disable-examples --disable-avdevice --extra-cflags='-MD -DHAVE_LRINT=1 -DHAVE_LRINTF=1 -DHAVE_RINT=1 -DHAVE_ROUND=1 -DHAVE_TRUNC=1 -DHAVE_CBRT=1 -DHAVE_ERF=1'"
          make -j %NUMBER_OF_PROCESSORS%
        )
        make install
        
    # ========== 产物打包/上传/发布 ==========
    - name: Package Build Artifacts
      shell: cmd
      run: |
        mkdir %WORKSPACE%\ffmpeg-build-output\bin 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\lib 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\include 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\licenses 2>nul || true
        
        :: 复制FFmpeg MSVC产物
        copy /Y %FFMPEG_INSTALL%\bin\*.dll %WORKSPACE%\ffmpeg-build-output\bin\
        copy /Y %FFMPEG_INSTALL%\lib\*.lib %WORKSPACE%\ffmpeg-build-output\lib\
        xcopy /E /Y %FFMPEG_INSTALL%\include\* %WORKSPACE%\ffmpeg-build-output\include\
        
        :: 暂时不复制x264产物（已禁用x264）
        echo 暂时不复制x264产物
        
        :: 复制许可证（仅FFmpeg）
        copy /Y %WORKSPACE%\ffmpeg\LICENSE.md %WORKSPACE%\ffmpeg-build-output\licenses\FFmpeg.txt 2>nul || true
        echo 暂时不复制x264许可证
        
        :: 验证MSVC产物
        dir %WORKSPACE%\ffmpeg-build-output\bin
        dir %WORKSPACE%\ffmpeg-build-output\lib
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}
        path: ${{ env.WORKSPACE }}\ffmpeg-build-output\
        retention-days: 90
        
    - name: Package as ZIP
      shell: powershell
      run: |
        Compress-Archive -Path ${{ env.WORKSPACE }}\ffmpeg-build-output\* -DestinationPath ${{ env.WORKSPACE }}\ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}.zip -Force
        
    - name: Create Release
      id: create_release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: n${{ env.FFPEG_VERSION }}-${{ github.run_number }}
        name: FFmpeg Windows Build v${{ env.FFPEG_VERSION }}-${{ github.run_number }}
        draft: false
        prerelease: false
        files: ${{ env.WORKSPACE }}\ffmpeg-windows-x64-shared-n${{ env.FFPEG_VERSION }}.zip
        body: |
          FFmpeg ${{ env.FFPEG_VERSION }} Windows build with:
          - MSVC 2022 (v14.38) toolchain (x64)
          - Shared libraries (DLL + MSVC import LIB)
          - Headers for development
          - x264 support temporarily disabled
          
          ## Files included:
          - Binaries (MSVC-compiled DLLs)
          - MSVC import libraries (.lib)
          - Header files
          - Licenses
          
          ## Version Info
          - Build Number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
