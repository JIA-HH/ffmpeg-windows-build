name: FFmpeg with MSVC (Optimized)

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release after build'
        required: false
        default: 'false'
        type: boolean
      build_x264:
        description: 'Build with x264 support'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  actions: read

env:
  FFMPEG_VERSION: 5.1.4
  WORKSPACE: ${{ github.workspace }}
  FFMPEG_INSTALL: ${{ github.workspace }}\ffmpeg-install
  X264_INSTALL: ${{ github.workspace }}\x264-install
  CACHE_VERSION: v2  # 增加缓存版本，便于强制更新

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: cmd
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    # 安装MSVC环境
    - name: Setup Visual Studio Environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        vsversion: 2022
        spectre: false
        
    # 安装必要的工具
    - name: Install Build Tools
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: '[17.0,)'
        
    # 缓存构建依赖
    - name: Cache Build Dependencies
      id: cache-deps
      uses: actions/cache@v4
      with:
        path: |
          C:\Program Files\NASM
          C:\Program Files\CMake
          ${{ env.WORKSPACE }}\msys64
        key: deps-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ hashFiles('**/build-msvc.yaml') }}
        restore-keys: |
          deps-${{ env.CACHE_VERSION }}-${{ runner.os }}-
          deps-${{ runner.os }}-
          
    - name: Install Build Dependencies
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        choco install nasm -y --no-progress
        choco install cmake -y --no-progress --install-arguments 'ADD_CMAKE_TO_PATH=System'
        choco install msys2 -y --no-progress
        refreshenv
        
    # 设置MSYS2环境（仅用于git等工具）
    - name: Setup MSYS2
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        C:\tools\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm git make wget unzip sed pkg-config mingw-w64-x86_64-yasm flex bison"
        
    # 克隆FFmpeg源码
    - name: Clone FFmpeg Source
      run: |
        cd %WORKSPACE%
        rmdir /s /q ffmpeg 2>nul || true
        git clone --depth=1 --branch=n%FFMPEG_VERSION% https://github.com/FFmpeg/FFmpeg.git ffmpeg
        cd ffmpeg && git rev-parse --short HEAD && cd ..
        
    # 克隆x264源码（可选）
    - name: Clone x264 Source
      if: github.event.inputs.build_x264 == 'true'
      run: |
        cd %WORKSPACE%
        rmdir /s /q x264 2>nul || true
        git clone --depth=1 https://code.videolan.org/videolan/x264.git x264
        cd x264 && git rev-parse --short HEAD && cd ..
        
    # 修复FFmpeg数学函数兼容性问题
    - name: Patch FFmpeg libm.h
      run: |
        cd %WORKSPACE%\ffmpeg\libavutil
        copy libm.h libm.h.bak
        powershell -Command "(Get-Content libm.h) -replace '#if !HAVE_', '#if 0 // disabled for MSVC - #if !HAVE_' | Set-Content libm.h"
        powershell -Command "(Get-Content libm.h) -replace '#elif !HAVE_', '#elif 0 // disabled for MSVC - #elif !HAVE_' | Set-Content libm.h"
        
    # 构建x264（如果启用）
    - name: Build x264
      if: github.event.inputs.build_x264 == 'true'
      run: |
        cd %WORKSPACE%\x264
        rmdir /s /q build 2>nul || true
        mkdir build && cd build
        
        :: 使用MinGW构建x264（更稳定的方法）
        C:\tools\msys64\usr\bin\bash.exe -lc "cd /d/a/ffmpeg-windows-build/ffmpeg-windows-build/x264/build && ../configure --host=x86_64-w64-mingw32 --enable-shared --disable-static --enable-strip --disable-cli --prefix='%X264_INSTALL%' && make -j$(nproc) && make install"
        
    # 配置FFmpeg
    - name: Configure FFmpeg
      id: configure-ffmpeg
      run: |
        cd %WORKSPACE%\ffmpeg
        rmdir /s /q ffbuild 2>nul || true
        
        :: 设置MSVC环境变量
        set CC=cl
        set CXX=cl
        set LD=link
        set AR=lib
        set RANLIB=echo
        set STRIP=echo
        
        :: 根据是否启用x264设置不同的配置
        if "${{ github.event.inputs.build_x264 }}" == "true" (
          set X264_CONFIG=--enable-libx264 --extra-cflags=-I%X264_INSTALL%\include --extra-ldflags=-LIBPATH:%X264_INSTALL%\lib
          echo Building FFmpeg with x264 support
        ) else (
          set X264_CONFIG=
          echo Building FFmpeg without x264 support
        )
        
        :: 使用MSYS2的bash执行configure，但使用MSVC编译器
        C:\tools\msys64\usr\bin\bash.exe -lc "cd /d/a/ffmpeg-windows-build/ffmpeg-windows-build/ffmpeg && CC=cl CXX=cl LD=link AR=lib ./configure --prefix='%FFMPEG_INSTALL%' --target-os=win32 --arch=x86_64 --toolchain=msvc --enable-shared --disable-static --disable-programs --disable-doc --disable-asm --extra-cflags='-MD -DHAVE_LRINT=1 -DHAVE_LRINTF=1 -DHAVE_RINT=1 -DHAVE_ROUND=1 -DHAVE_TRUNC=1 -DHAVE_CBRT=1 -DHAVE_ERF=1' %X264_CONFIG%"
        
        :: 检查配置是否成功
        if not exist ffbuild\config.mak (
          echo ERROR: Configure failed - config.mak not found
          dir ffbuild
          powershell -Command "Get-Content ffbuild\config.log | Select-Object -Last 20"
          exit 1
        )
        echo "FFmpeg configuration completed successfully"
        
    # 编译FFmpeg（第一次尝试）
    - name: Build FFmpeg (Attempt 1)
      id: build-ffmpeg-1
      run: |
        cd %WORKSPACE%\ffmpeg
        
        :: 使用nmake编译，更稳定
        nmake || (
          echo First build attempt failed, will try with alternative configuration...
          exit 1
        )
        echo "FFmpeg build completed successfully (attempt 1)"
        
    # 备用编译方案（如果第一次失败）
    - name: Build FFmpeg (Attempt 2 - Fallback)
      if: steps.build-ffmpeg-1.outcome == 'failure'
      run: |
        cd %WORKSPACE%\ffmpeg
        rmdir /s /q ffbuild 2>nul || true
        
        :: 使用更保守的配置重新编译
        set CC=cl
        set CXX=cl
        set LD=link
        set AR=lib
        set RANLIB=echo
        set STRIP=echo
        
        :: 禁用可能有问题的组件
        C:\tools\msys64\usr\bin\bash.exe -lc "cd /d/a/ffmpeg-windows-build/ffmpeg-windows-build/ffmpeg && CC=cl CXX=cl LD=link AR=lib ./configure --prefix='%FFMPEG_INSTALL%' --target-os=win32 --arch=x86_64 --toolchain=msvc --enable-shared --disable-static --disable-programs --disable-doc --disable-asm --disable-avdevice --disable-swscale --extra-cflags='-MD -DHAVE_LRINT=1 -DHAVE_LRINTF=1 -DHAVE_RINT=1 -DHAVE_ROUND=1 -DHAVE_TRUNC=1 -DHAVE_CBRT=1 -DHAVE_ERF=1'"
        
        :: 使用nmake编译
        nmake
        echo "FFmpeg build completed successfully (fallback attempt)"
        
    # 安装FFmpeg
    - name: Install FFmpeg
      if: steps.build-ffmpeg-1.outcome == 'success' || steps.build-ffmpeg-1.outcome == 'failure'
      run: |
        cd %WORKSPACE%\ffmpeg
        nmake install
        
    # 打包构建结果
    - name: Package Build Artifacts
      run: |
        mkdir %WORKSPACE%\ffmpeg-build-output\bin 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\lib 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\include 2>nul || true
        mkdir %WORKSPACE%\ffmpeg-build-output\licenses 2>nul || true
        
        :: 复制FFmpeg产物
        copy /Y %FFMPEG_INSTALL%\bin\*.dll %WORKSPACE%\ffmpeg-build-output\bin\ 2>nul || true
        copy /Y %FFMPEG_INSTALL%\lib\*.lib %WORKSPACE%\ffmpeg-build-output\lib\ 2>nul || true
        xcopy /E /Y %FFMPEG_INSTALL%\include\* %WORKSPACE%\ffmpeg-build-output\include\ 2>nul || true
        
        :: 复制x264产物（如果构建了）
        if "${{ github.event.inputs.build_x264 }}" == "true" (
          copy /Y %X264_INSTALL%\bin\*.dll %WORKSPACE%\ffmpeg-build-output\bin\ 2>nul || true
          copy /Y %X264_INSTALL%\lib\*.lib %WORKSPACE%\ffmpeg-build-output\lib\ 2>nul || true
          xcopy /E /Y %X264_INSTALL%\include\* %WORKSPACE%\ffmpeg-build-output\include\ 2>nul || true
          copy /Y %WORKSPACE%\x264\COPYING %WORKSPACE%\ffmpeg-build-output\licenses\x264.txt 2>nul || true
        )
        
        :: 复制许可证
        copy /Y %WORKSPACE%\ffmpeg\LICENSE.md %WORKSPACE%\ffmpeg-build-output\licenses\FFmpeg.txt 2>nul || true
        
        :: 验证产物
        dir %WORKSPACE%\ffmpeg-build-output\bin
        dir %WORKSPACE%\ffmpeg-build-output\lib
        
    # 上传构建结果
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows-x64-shared-n${{ env.FFMPEG_VERSION }}-${{ github.run_number }}
        path: ${{ env.WORKSPACE }}\ffmpeg-build-output\
        retention-days: 90
        
    # 创建ZIP包
    - name: Package as ZIP
      run: |
        cd %WORKSPACE%
        powershell -Command "Compress-Archive -Path ffmpeg-build-output\* -DestinationPath ffmpeg-windows-x64-shared-n${{ env.FFMPEG_VERSION }}-${{ github.run_number }}.zip -Force"
        
    # 创建发布（如果需要）
    - name: Create Release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: n${{ env.FFMPEG_VERSION }}-${{ github.run_number }}
        name: FFmpeg Windows Build v${{ env.FFMPEG_VERSION }}-${{ github.run_number }}
        draft: false
        prerelease: false
        files: ${{ env.WORKSPACE }}\ffmpeg-windows-x64-shared-n${{ env.FFMPEG_VERSION }}-${{ github.run_number }}.zip
        body: |
          FFmpeg ${{ env.FFMPEG_VERSION }} Windows build with:
          - MSVC 2022 (v14.38) toolchain (x64)
          - Shared libraries (DLL + MSVC import LIB)
          - Headers for development
          - x264 support: ${{ github.event.inputs.build_x264 }}
          
          ## Files included:
          - Binaries (MSVC-compiled DLLs)
          - MSVC import libraries (.lib)
          - Header files
          - Licenses
          
          ## Version Info
          - Build Number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
